"""
ìš´ì„¸ ê³„ì‚° í•µì‹¬ ë¡œì§
"""
from datetime import date, datetime
import random
import hashlib
import json
from typing import Dict, List, Optional
from django.core.cache import cache
from django.conf import settings
from .saju_calculator import SajuCalculator
from .lunar_converter import lunar_to_solar

class FortuneCalculator:
    """ìš´ì„¸ ê³„ì‚° í´ë˜ìŠ¤"""
    
    # ìƒ‰ìƒ ì½”ë“œì™€ ì´ë¦„ ë§¤í•‘
    COLOR_NAMES = {
        '#FF0000': 'ë¹¨ê°„ìƒ‰',
        '#FF6347': 'í† ë§ˆí† ìƒ‰',
        '#FFA500': 'ì£¼í™©ìƒ‰',
        '#FFB347': 'ë°ì€ ì£¼í™©ìƒ‰',
        '#FFFF00': 'ë…¸ë€ìƒ‰',
        '#F0E68C': 'ì¹´í‚¤ìƒ‰',
        '#228B22': 'ì´ˆë¡ìƒ‰',
        '#32CD32': 'ì—°ë‘ìƒ‰',
        '#90EE90': 'ì—°í•œ ì´ˆë¡ìƒ‰',
        '#00FF00': 'ë¼ì„ìƒ‰',
        '#008000': 'ì§„ì´ˆë¡ìƒ‰',
        '#0000FF': 'íŒŒë€ìƒ‰',
        '#000080': 'ë‚¨ìƒ‰',
        '#87CEEB': 'í•˜ëŠ˜ìƒ‰',
        '#4169E1': 'ë¡œì—´ë¸”ë£¨',
        '#800080': 'ë³´ë¼ìƒ‰',
        '#DA70D6': 'ì—°ë³´ë¼ìƒ‰',
        '#FFC0CB': 'ë¶„í™ìƒ‰',
        '#FFB6C1': 'ì—°ë¶„í™ìƒ‰',
        '#FFFFFF': 'í°ìƒ‰',
        '#000000': 'ê²€ì€ìƒ‰',
        '#808080': 'íšŒìƒ‰',
        '#C0C0C0': 'ì€ìƒ‰',
        '#FFD700': 'ê¸ˆìƒ‰',
        '#D2691E': 'ê°ˆìƒ‰',
        '#8B4513': 'ì§„ê°ˆìƒ‰',
        '#DEB887': 'ì—°ê°ˆìƒ‰',
        '#F5DEB3': 'ë² ì´ì§€ìƒ‰',
    }
    
    # ìƒ‰ìƒ ì´ë¦„ -> HEX ë§¤í•‘ (ì—­ë°©í–¥)
    NAME_TO_HEX = {name: hex_code for hex_code, name in COLOR_NAMES.items()}
    
    # ë³„ìë¦¬ë³„ í–‰ìš´ìƒ‰ (ê¸°ë³¸ ìƒ‰ìƒ í’€)
    STAR_SIGN_COLORS = {
        'ì–‘ìë¦¬': ['ë¹¨ê°„ìƒ‰', 'ì£¼í™©ìƒ‰', 'í°ìƒ‰', 'ê¸ˆìƒ‰', 'ë¶„í™ìƒ‰'],
        'í™©ì†Œìë¦¬': ['ì´ˆë¡ìƒ‰', 'ë¶„í™ìƒ‰', 'ë² ì´ì§€ìƒ‰', 'ê°ˆìƒ‰', 'ì—°ë‘ìƒ‰'],
        'ìŒë‘¥ì´ìë¦¬': ['ë…¸ë€ìƒ‰', 'ì€ìƒ‰', 'í•˜ëŠ˜ìƒ‰', 'ì—°ë³´ë¼ìƒ‰', 'í°ìƒ‰'],
        'ê²Œìë¦¬': ['í°ìƒ‰', 'ì€ìƒ‰', 'ì—°ë³´ë¼ìƒ‰', 'í•˜ëŠ˜ìƒ‰', 'ë¶„í™ìƒ‰'],
        'ì‚¬ììë¦¬': ['ê¸ˆìƒ‰', 'ì£¼í™©ìƒ‰', 'ë¹¨ê°„ìƒ‰', 'ë…¸ë€ìƒ‰', 'í°ìƒ‰'],
        'ì²˜ë…€ìë¦¬': ['ë‚¨ìƒ‰', 'íšŒìƒ‰', 'ë² ì´ì§€ìƒ‰', 'ì´ˆë¡ìƒ‰', 'í°ìƒ‰'],
        'ì²œì¹­ìë¦¬': ['ë¶„í™ìƒ‰', 'í•˜ëŠ˜ìƒ‰', 'ì—°ë³´ë¼ìƒ‰', 'ë² ì´ì§€ìƒ‰', 'í°ìƒ‰'],
        'ì „ê°ˆìë¦¬': ['ì§„í•œ ë¹¨ê°„ìƒ‰', 'ê²€ì€ìƒ‰', 'ë³´ë¼ìƒ‰', 'ë‚¨ìƒ‰', 'ê¸ˆìƒ‰'],
        'ì‚¬ìˆ˜ìë¦¬': ['ë³´ë¼ìƒ‰', 'ë‚¨ìƒ‰', 'ì£¼í™©ìƒ‰', 'ë¹¨ê°„ìƒ‰', 'ê¸ˆìƒ‰'],
        'ì—¼ì†Œìë¦¬': ['ê°ˆìƒ‰', 'ê²€ì€ìƒ‰', 'íšŒìƒ‰', 'ë‚¨ìƒ‰', 'ë² ì´ì§€ìƒ‰'],
        'ë¬¼ë³‘ìë¦¬': ['í•˜ëŠ˜ìƒ‰', 'íŒŒë€ìƒ‰', 'ì€ìƒ‰', 'ì—°ë³´ë¼ìƒ‰', 'í°ìƒ‰'],
        'ë¬¼ê³ ê¸°ìë¦¬': ['ì—°ë³´ë¼ìƒ‰', 'ì—°ë‘ìƒ‰', 'ë¶„í™ìƒ‰', 'í•˜ëŠ˜ìƒ‰', 'ì€ìƒ‰']
    }

    # ë ë³„ í–‰ìš´ìƒ‰
    CHINESE_ZODIAC_COLORS = {
        'ì¥ë ': ['íŒŒë€ìƒ‰', 'ê¸ˆìƒ‰', 'ì´ˆë¡ìƒ‰'],
        'ì†Œë ': ['í°ìƒ‰', 'ë…¸ë€ìƒ‰', 'ì´ˆë¡ìƒ‰'],
        'í˜¸ë‘ì´ë ': ['íŒŒë€ìƒ‰', 'íšŒìƒ‰', 'ì£¼í™©ìƒ‰'],
        'í† ë¼ë ': ['ë¶„í™ìƒ‰', 'ì—°ë³´ë¼ìƒ‰', 'ë¹¨ê°„ìƒ‰'],
        'ìš©ë ': ['ê¸ˆìƒ‰', 'ì€ìƒ‰', 'íšŒìƒ‰'],
        'ë±€ë ': ['ë¹¨ê°„ìƒ‰', 'ë…¸ë€ìƒ‰', 'ê²€ì€ìƒ‰'],
        'ë§ë ': ['ë…¸ë€ìƒ‰', 'ì´ˆë¡ìƒ‰', 'ë¹¨ê°„ìƒ‰'],
        'ì–‘ë ': ['ì´ˆë¡ìƒ‰', 'ë¹¨ê°„ìƒ‰', 'ì—°ë³´ë¼ìƒ‰'],
        'ì›ìˆ­ì´ë ': ['í°ìƒ‰', 'ê¸ˆìƒ‰', 'í•˜ëŠ˜ìƒ‰'],
        'ë‹­ë ': ['ê¸ˆìƒ‰', 'ê°ˆìƒ‰', 'ë…¸ë€ìƒ‰'],
        'ê°œë ': ['ì´ˆë¡ìƒ‰', 'ë¹¨ê°„ìƒ‰', 'ì—°ë³´ë¼ìƒ‰'],
        'ë¼ì§€ë ': ['ë…¸ë€ìƒ‰', 'íšŒìƒ‰', 'ê°ˆìƒ‰']
    }

    # ì „ì²´ ìƒ‰ìƒ í’€ (ëœë¤ ë³´ì™„ìš©)
    ALL_COLORS = [
        'ë¹¨ê°„ìƒ‰', 'ì£¼í™©ìƒ‰', 'ë…¸ë€ìƒ‰', 'ì´ˆë¡ìƒ‰', 'ì—°ë‘ìƒ‰',
        'íŒŒë€ìƒ‰', 'í•˜ëŠ˜ìƒ‰', 'ë‚¨ìƒ‰', 'ë³´ë¼ìƒ‰', 'ì—°ë³´ë¼ìƒ‰',
        'ë¶„í™ìƒ‰', 'í°ìƒ‰', 'ê²€ì€ìƒ‰', 'íšŒìƒ‰', 'ì€ìƒ‰',
        'ê¸ˆìƒ‰', 'ê°ˆìƒ‰', 'ë² ì´ì§€ìƒ‰', 'ì§„í•œ ë¹¨ê°„ìƒ‰'
    ]
    
    # def __init__(self):
    #     self.cache_ttl = getattr(settings, 'CACHE_TTL', 86400)  # 24ì‹œê°„
    def __init__(self):
        self.cache_ttl = getattr(settings, 'CACHE_TTL', 86400)
        self.saju_calc = SajuCalculator()  # ì´ ì¤„ ì¶”ê°€
    
    def calculate_fortune(
        self,
        birth_date: date,
        gender: str,
        birth_time: Optional[datetime] = None,
        chinese_name: Optional[str] = None,
        mbti: Optional[str] = None,  # MBTI ì¶”ê°€
        calendar_type: str = 'solar',  # ì–‘ë ¥/ìŒë ¥ êµ¬ë¶„ (ê¸°ë³¸ê°’: ì–‘ë ¥)
        user_id: Optional[int] = None,  # ë¡œê·¸ì¸ ì‚¬ìš©ì ID (ë¡œë˜ ë²ˆí˜¸ìš©)
        session_key: Optional[str] = None  # ì„¸ì…˜ í‚¤ (ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì ë¡œë˜ ë²ˆí˜¸ìš©)
    ) -> Dict:
        """
        ìš´ì„¸ ê³„ì‚° ë©”ì¸ í•¨ìˆ˜
        """
        # ìŒë ¥ì¸ ê²½ìš° ì–‘ë ¥ìœ¼ë¡œ ë³€í™˜
        original_birth_date = birth_date  # ì›ë³¸ ìŒë ¥ ë‚ ì§œ ë³´ê´€ (ë  ê³„ì‚°ìš©)
        if calendar_type == 'lunar':
            solar_date = lunar_to_solar(birth_date)
            if solar_date:
                birth_date = solar_date  # ì–‘ë ¥ìœ¼ë¡œ ë³€í™˜ëœ ë‚ ì§œ ì‚¬ìš©
                print(f"[DEBUG] ìŒë ¥ {original_birth_date} -> ì–‘ë ¥ {birth_date} ë³€í™˜")
            else:
                print(f"[WARNING] ìŒë ¥ ë³€í™˜ ì‹¤íŒ¨, ì›ë³¸ ë‚ ì§œ ì‚¬ìš©")

        # ì˜¤ëŠ˜ ë‚ ì§œ
        today = date.today()

        # ê³ ìœ  ì‹œë“œ ìƒì„± (ë‚ ì§œ + ìƒë…„ì›”ì¼ë¡œ ë§¤ì¼ ê°™ì€ ìš´ì„¸ ë³´ì¥)
        seed_string = f"{today.isoformat()}-{birth_date.isoformat()}-{gender}"
        seed = int(hashlib.md5(seed_string.encode()).hexdigest(), 16)
        random.seed(seed)

        # ì‚¬ì£¼ ë°ì´í„° ê³„ì‚° (ìš´ì„¸ ì ìˆ˜ ê³„ì‚°ì— í•„ìš”í•˜ë¯€ë¡œ ë¨¼ì € ê³„ì‚°)
        saju_data = self._calculate_saju(birth_date, birth_time)

        # ê° ìš´ë³„ ì ìˆ˜ ê³„ì‚° (ì‚¬ì£¼ ì˜¤í–‰ ë°ì´í„° ë°˜ì˜)
        fortune_scores = self._calculate_all_fortunes(birth_date, today, saju_data)
        
        # ë³„ìë¦¬ ê³„ì‚° (ì–‘ë ¥ ë‚ ì§œë¡œ)
        zodiac_sign = self._get_zodiac_sign(birth_date)

        # ë  ê³„ì‚°
        # ìŒë ¥ì¸ ê²½ìš°: ì›ë³¸ ìŒë ¥ ë‚ ì§œì˜ ë…„ë„ë¡œ ë  ê³„ì‚° (ìŒë ¥ ì„¤ë‚  ê¸°ì¤€)
        # ì–‘ë ¥ì¸ ê²½ìš°: ì…ì¶˜ ê¸°ì¤€ìœ¼ë¡œ ë  ê³„ì‚°
        if calendar_type == 'lunar':
            # ìŒë ¥ì€ ë…„ë„ë§Œ ì‚¬ìš© (ìŒë ¥ 1ì›” 1ì¼ì´ ì„¤ë‚  = ë ê°€ ë°”ë€ŒëŠ” ë‚ )
            chinese_zodiac = self._get_chinese_zodiac_lunar(original_birth_date)
        else:
            # ì–‘ë ¥ì€ ì…ì¶˜ ê¸°ì¤€
            chinese_zodiac = self._get_chinese_zodiac(birth_date)
        
        # í–‰ìš´ì˜ ìƒ‰ìƒë“¤ ê²°ì • (ë³„ìë¦¬ + ë  + ë‚ ì§œ + ìš´ì„¸ì ìˆ˜ ê¸°ë°˜)
        lucky_colors = self._determine_lucky_colors(
            zodiac_sign, chinese_zodiac, today, fortune_scores
        )

        # ë¡œë˜ ë²ˆí˜¸ 6ê°œ ìƒì„± (user_id ë˜ëŠ” session_key ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©ìë³„ ë‹¤ë¥¸ ë²ˆí˜¸)
        lotto_numbers = self._generate_lucky_lotto_numbers(
            birth_date, today, fortune_scores, gender, user_id, session_key
        )
        
        # í–‰ìš´ì˜ ì•„ì´í…œ (user_id ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©ìë³„ ì¼ê´€ëœ ì•„ì´í…œ, ê°€ì¥ ë‚®ì€ ìš´ ë³´ì™„ ê¸°ë°˜)
        lucky_item = self._determine_lucky_item(
            zodiac_sign, today, user_id, session_key, lucky_colors,
            fortune_score=fortune_scores['total'],
            fortune_scores=fortune_scores
        )

        # ìƒì„¸ ìš´ì„¸ í…ìŠ¤íŠ¸ ìƒì„± (LLM ì‹œë„ í›„ ì‹¤íŒ¨ì‹œ ê¸°ì¡´ ë¡œì§)
        fortune_texts = self._generate_fortune_text_with_llm(
            birth_date, gender, saju_data, zodiac_sign, chinese_zodiac, fortune_scores, mbti,
            lucky_item['main'], lucky_item['zodiac']
        )

        if fortune_texts:
            # LLMì´ ì ìˆ˜ë„ í•¨ê»˜ ë°˜í™˜í•œ ê²½ìš°, ê·¸ ì ìˆ˜ë¥¼ ì‚¬ìš© (í…ìŠ¤íŠ¸ì™€ ì ìˆ˜ ì¼ì¹˜)
            if 'scores' in fortune_texts:
                llm_scores = fortune_texts['scores']
                fortune_scores = {
                    'total': llm_scores.get('total', fortune_scores['total']),
                    'money': llm_scores.get('money', fortune_scores['money']),
                    'love': llm_scores.get('love', fortune_scores['love']),
                    'study': llm_scores.get('study', fortune_scores['study']),
                    'work': llm_scores.get('work', fortune_scores['work'])
                }
                print(f"[DEBUG] LLM ì ìˆ˜ ì‚¬ìš©: {fortune_scores}")

                # LLM ì ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ lucky_item ì¬ê³„ì‚° (ë‚®ì€ ìš´ì„¸ 2ê°œê°€ ë°”ë€” ìˆ˜ ìˆìŒ)
                lucky_item = self._determine_lucky_item(
                    zodiac_sign, today, user_id, session_key, lucky_colors,
                    fortune_score=fortune_scores['total'],
                    fortune_scores=fortune_scores
                )

            # LLM lucky_item ì„¤ëª… ì‚¬ìš© ì•ˆí•¨ - í•˜ë“œì½”ë”©ëœ ì„¤ëª… ì‚¬ìš©
            # LLMì´ ì•„ì´í…œ ì´ë¦„ì„ ì œëŒ€ë¡œ ë°˜ì˜í•˜ì§€ ì•Šì•„ì„œ ë¹„í™œì„±í™”
            pass
        else:
            print("[DEBUG] LLM ìƒì„± ì‹¤íŒ¨, ê¸°ì¡´ ë¡œì§ ì‚¬ìš©")
            fortune_texts = self._generate_fortune_texts(fortune_scores, zodiac_sign, chinese_zodiac)
        
        return {
            'fortune_score': fortune_scores['total'],
            'fortune_scores': fortune_scores,
            'fortune_texts': fortune_texts,
            'saju_data': saju_data,
            'zodiac_sign': zodiac_sign,
            'chinese_zodiac': chinese_zodiac,
            'lucky_color': lucky_colors[0] if lucky_colors else 'íŒŒë€ìƒ‰',
            'lucky_colors': lucky_colors,
            'lotto_numbers': lotto_numbers,  # ë¡œë˜ ë²ˆí˜¸ ì¶”ê°€
            'lucky_item': lucky_item,
            'calculation_date': today.isoformat(),
            'birth_date': birth_date.isoformat(),  # ë¯¸ì„±ë…„ì ì²´í¬ìš©
            'gender': gender,  # ë¡œë˜ ì¬ìƒì„±ìš©
            'user_id': user_id,  # ë¡œê·¸ì¸ ì‚¬ìš©ì ì‹ë³„ìš©
            'session_key': session_key,  # ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì ì‹ë³„ìš©
            'mbti': mbti  # ê²°ê³¼ì— MBTI í¬í•¨
        }

    def _generate_fortune_text_with_llm(
        self,
        birth_date: date,
        gender: str,
        saju: Dict,
        zodiac: str,
        chinese_zodiac: str,
        scores: Dict,
        mbti: Optional[str] = None,
        lucky_item_name: Optional[str] = None,
        zodiac_item_name: Optional[str] = None
    ) -> Optional[Dict]:
        """Geminië¥¼ ì‚¬ìš©í•œ ìš´ì„¸ í…ìŠ¤íŠ¸ ìƒì„± (ìºì‹± ì ìš©)"""
        # ìºì‹œ í‚¤ ìƒì„±
        cache_key = f"fortune_text_{birth_date}_{gender}_{zodiac}_{chinese_zodiac}_{mbti}_{lucky_item_name}_{date.today()}"
        cached_result = cache.get(cache_key)
        
        if cached_result:
            print("[DEBUG] ìºì‹œëœ ìš´ì„¸ í…ìŠ¤íŠ¸ ì‚¬ìš©")
            return cached_result

        try:
            import google.generativeai as genai
            
            api_key = settings.GEMINI_API_KEY
            if not api_key:
                return None
                
            genai.configure(api_key=api_key)
            
            # ëª¨ë¸ ì„¤ì • (flash ëª¨ë¸ ìš°ì„ )
            model = genai.GenerativeModel('gemini-2.0-flash')
            
            mbti_info = f"- MBTI: {mbti}" if mbti else "- MBTI: ì •ë³´ ì—†ìŒ"
            lucky_item_info = f"- ìš´ì„¸ ê¸°ë°˜ í–‰ìš´ ì•„ì´í…œ: {lucky_item_name}" if lucky_item_name else ""
            zodiac_item_info = f"- ë³„ìë¦¬ í–‰ìš´ ì•„ì´í…œ: {zodiac_item_name}" if zodiac_item_name else ""
            
            prompt = f"""
ë‹¹ì‹ ì€ ì „ë¬¸ ìš´ì„¸ ìƒë‹´ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ 'ë„¤ì´ë²„ ìš´ì„¸' ìŠ¤íƒ€ì¼ì˜ ì˜¤ëŠ˜ì˜ ìš´ì„¸ë¥¼ ì‘ì„±í•˜ê³ , ê° ìš´ì„¸ì˜ ì ìˆ˜ë¥¼ ë§¤ê²¨ì£¼ì„¸ìš”.

[ì‚¬ìš©ì ì •ë³´]
- ìƒë…„ì›”ì¼: {birth_date}
- ì„±ë³„: {'ë‚¨ì„±' if gender == 'M' else 'ì—¬ì„±'}
- ë³„ìë¦¬: {zodiac}
- ë : {chinese_zodiac}
{mbti_info}
{lucky_item_info}
- ì‚¬ì£¼: {saju['year']}ë…„ {saju['month']}ì›” {saju['day']}ì¼ {saju['hour']}ì‹œ (ê°„ì§€)
- ì˜¤ëŠ˜ ë‚ ì§œ: {date.today()}

[ì‘ì„± ê°€ì´ë“œ]
1. **ë§íˆ¬**: "~í•©ë‹ˆë‹¤", "~ì…ë‹ˆë‹¤" ì²´ì˜ ì •ì¤‘í•˜ê³  ë¶€ë“œëŸ¬ìš´ ë¬¸ì²´ (ë„¤ì´ë²„ ìš´ì„¸ ìŠ¤íƒ€ì¼)
2. **ê¸¸ì´**: ê° í•­ëª©ë‹¹ 6~8ë¬¸ì¥ (ì•½ 400ì ë‚´ì™¸) - **ì¶©ë¶„íˆ ê¸¸ê³  ìƒì„¸í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.**
3. **ì ìˆ˜ ë§¤ê¸°ê¸° (ì¤‘ìš”)**:
   - ê° ìš´ì„¸ì˜ ë‚´ìš©ì„ ë¨¼ì € ì‘ì„±í•œ í›„, ê·¸ ë‚´ìš©ì— ë§ëŠ” ì ìˆ˜ë¥¼ 50~100ì  ì‚¬ì´ì—ì„œ ë§¤ê²¨ì£¼ì„¸ìš”.
   - ì ìˆ˜ì™€ í…ìŠ¤íŠ¸ì˜ í†¤ì´ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤:
     * 90-100ì : ë§¤ìš° ì¢‹ì€ ìš´ì„¸, ì ê·¹ì ìœ¼ë¡œ í–‰ë™ ê¶Œì¥
     * 75-89ì : ì¢‹ì€ ìš´ì„¸, ê¸ì •ì ì¸ ê¸°ìš´
     * 60-74ì : ë³´í†µ ìš´ì„¸, ì‹ ì¤‘í•¨ ê¶Œì¥, ì•½ê°„ì˜ ì£¼ì˜ í•„ìš”
     * 50-59ì : ë‹¤ì†Œ ì–´ë ¤ìš´ ìš´ì„¸, ì¡°ì‹¬ìŠ¤ëŸ¬ìš´ ì ‘ê·¼ ê¶Œì¥
   - **ìš´ì„¸ í…ìŠ¤íŠ¸ê°€ ì¢‹ìœ¼ë©´ ì ìˆ˜ë„ ë†’ê²Œ, ì£¼ì˜ê°€ í•„ìš”í•œ ë‚´ìš©ì´ë©´ ì ìˆ˜ë„ ë‚®ê²Œ** ë§¤ê²¨ì£¼ì„¸ìš”.
4. **ì ìˆ˜ ì–¸ê¸‰ ê¸ˆì§€**: í…ìŠ¤íŠ¸ ë‚´ì—ì„œ "90ì ", "85ì " ë“± ìˆ«ìë¥¼ ì§ì ‘ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”.
5. **MBTI ë°˜ì˜ ë°©ì‹**:
   - "MBTIê°€ ~ë¼ì„œ" ê°™ì€ ë§ì€ í•˜ì§€ ë§ˆì„¸ìš”.
   - ì‚¬ìš©ìì˜ MBTI ì„±í–¥ì— ë§ëŠ” ì¡°ì–¸ì„ ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ë‚´ì„¸ìš”.
6. **í–‰ìš´ì˜ ì•„ì´í…œ ì„¤ëª… (ì¤‘ìš”)**:
   - ìš´ì„¸ ê¸°ë°˜ ì•„ì´í…œ '{lucky_item_name}' ì„¤ëª…: 2ë¬¸ì¥ (60~80ì)
     * ë°˜ë“œì‹œ '{lucky_item_name}'ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ ì„¤ëª…ì— í¬í•¨í•´ì£¼ì„¸ìš”!
     * ì˜ˆ: "{lucky_item_name}ì€(ëŠ”) ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ ì¢‹ì€ ê¸°ìš´ì„ ì „í•´ì¤ë‹ˆë‹¤. íŠ¹íˆ ëŒ€ì¸ê´€ê³„ì—ì„œ ê¸ì •ì ì¸ ì—ë„ˆì§€ë¥¼ ë°œì‚°í•©ë‹ˆë‹¤."
   - ë³„ìë¦¬({zodiac}) ì•„ì´í…œ '{zodiac_item_name}' ì„¤ëª…: 2ë¬¸ì¥ (60~80ì)
     * ë°˜ë“œì‹œ '{zodiac_item_name}'ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ ì„¤ëª…ì— í¬í•¨í•´ì£¼ì„¸ìš”!
     * ì˜ˆ: "{zodiac_item_name}ì€(ëŠ”) {zodiac}ì¸ ë‹¹ì‹ ì—ê²Œ íŠ¹ë³„í•œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ ê¸ì •ì ì¸ ë³€í™”ê°€ ì°¾ì•„ì˜¬ ê²ƒì…ë‹ˆë‹¤."
   - **ë‘ ì„¤ëª…ì˜ ê¸¸ì´ë¥¼ ë¹„ìŠ·í•˜ê²Œ ë§ì¶°ì£¼ì„¸ìš” (ì°¨ì´ 10ì ì´ë‚´)**
7. **ì´ìš´ ì ìˆ˜**: ì¬ë¬¼ìš´, ì• ì •ìš´, í•™ì—…ìš´, ì§ì¥ìš´ ì ìˆ˜ì˜ í‰ê· ì„ ë°˜ì˜¬ë¦¼í•˜ì—¬ ì´ìš´ ì ìˆ˜ë¡œ ì‚¬ìš©í•´ì£¼ì„¸ìš”.

[ì¶œë ¥ í˜•ì‹]
ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš” (ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì—†ì´ ìˆœìˆ˜ JSONë§Œ):
{{{{
    "total": "ì´ìš´ ë‚´ìš©...",
    "money": "ì¬ë¬¼ìš´ ë‚´ìš©...",
    "love": "ì• ì •ìš´ ë‚´ìš©...",
    "study": "í•™ì—…ìš´ ë‚´ìš©...",
    "work": "ì§ì¥ìš´ ë‚´ìš©...",
    "scores": {{{{
        "total": ì´ìš´ì ìˆ˜,
        "money": ì¬ë¬¼ìš´ì ìˆ˜,
        "love": ì• ì •ìš´ì ìˆ˜,
        "study": í•™ì—…ìš´ì ìˆ˜,
        "work": ì§ì¥ìš´ì ìˆ˜
    }}}},
    "lucky_item": {{{{
        "description": "{lucky_item_name}ì€(ëŠ”)... (2ë¬¸ì¥, 60~80ì, ì•„ì´í…œ ì´ë¦„ í¬í•¨ í•„ìˆ˜)",
        "zodiac_description": "{zodiac_item_name}ì€(ëŠ”)... (2ë¬¸ì¥, 60~80ì, ì•„ì´í…œ ì´ë¦„ í¬í•¨ í•„ìˆ˜)"
    }}}}
}}}}
"""
            print("[DEBUG] Gemini ìš´ì„¸ ìƒì„± ìš”ì²­...")
            response = model.generate_content(prompt)
            
            # JSON íŒŒì‹±
            text = response.text.strip()
            if text.startswith('```json'):
                text = text[7:]
            if text.endswith('```'):
                text = text[:-3]
            
            result = json.loads(text.strip())
            print("[DEBUG] Gemini ìš´ì„¸ ìƒì„± ì„±ê³µ!")
            
            # ê²°ê³¼ ìºì‹± (24ì‹œê°„)
            cache.set(cache_key, result, 60 * 60 * 24)
            
            return result
            
        except Exception as e:
            print(f"[ERROR] Gemini ìš´ì„¸ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
            return None
    
    def _calculate_all_fortunes(self, birth_date: date, today: date, saju_data: Dict = None) -> Dict:
        """ê° ìš´ë³„ ì ìˆ˜ ê³„ì‚° (ì‚¬ì£¼ ì˜¤í–‰ ê¸°ë°˜, ìµœì†Œ 50ì )"""
        base = random.randint(55, 90)  # 55~90ì  ì‚¬ì´ (ê¸°ë³¸, 50ì ëŒ€ë„ ê°€ëŠ¥)

        # ì‚¬ì£¼ ì˜¤í–‰ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë°˜ì˜
        ohaeng_bonus = {'money': 0, 'love': 0, 'study': 0, 'work': 0}

        if saju_data and 'ohaeng_scores' in saju_data:
            ohaeng = saju_data['ohaeng_scores']
            # ì˜¤í–‰ ì ìˆ˜: ëª©(æœ¨), í™”(ç«), í† (åœŸ), ê¸ˆ(é‡‘), ìˆ˜(æ°´)
            # ëª© = 18, í™” = 12, í†  = 6, ê¸ˆ = 16, ìˆ˜ = 12 ê°™ì€ í˜•íƒœ

            # ì˜¤í–‰ë³„ ìš´ì„¸ ì˜í–¥ ë§¤í•‘
            # ê¸ˆ(é‡‘) -> ì¬ë¬¼ìš´ (ê¸ˆì „, ì¬ë¬¼)
            # í™”(ç«) -> ì• ì •ìš´ (ì—´ì •, ì‚¬ë‘)
            # ìˆ˜(æ°´) -> í•™ì—…ìš´ (ì§€í˜œ, ìœ ì—°í•¨)
            # ëª©(æœ¨) -> ì§ì¥ìš´ (ì„±ì¥, ë°œì „)
            # í† (åœŸ) -> ì „ì²´ ì•ˆì • (ê· í˜•, ì¤‘ì‹¬)

            total_ohaeng = sum(ohaeng.values()) if ohaeng else 1
            avg_ohaeng = total_ohaeng / 5 if total_ohaeng > 0 else 10

            # ê° ì˜¤í–‰ì´ í‰ê· ë³´ë‹¤ ë†’ìœ¼ë©´ ë³´ë„ˆìŠ¤, ë‚®ìœ¼ë©´ í˜ë„í‹°
            ê¸ˆ = ohaeng.get('ê¸ˆ', 0)
            í™” = ohaeng.get('í™”', 0)
            ìˆ˜ = ohaeng.get('ìˆ˜', 0)
            ëª© = ohaeng.get('ëª©', 0)
            í†  = ohaeng.get('í† ', 0)

            # ë³´ë„ˆìŠ¤ ê³„ì‚° (-10 ~ +10 ë²”ìœ„)
            ohaeng_bonus['money'] = int((ê¸ˆ - avg_ohaeng) / avg_ohaeng * 10) if avg_ohaeng > 0 else 0
            ohaeng_bonus['love'] = int((í™” - avg_ohaeng) / avg_ohaeng * 10) if avg_ohaeng > 0 else 0
            ohaeng_bonus['study'] = int((ìˆ˜ - avg_ohaeng) / avg_ohaeng * 10) if avg_ohaeng > 0 else 0
            ohaeng_bonus['work'] = int((ëª© - avg_ohaeng) / avg_ohaeng * 10) if avg_ohaeng > 0 else 0

            # í† (åœŸ)ê°€ ê°•í•˜ë©´ ì „ì²´ ì•ˆì • ë³´ë„ˆìŠ¤
            if í†  > avg_ohaeng:
                stability_bonus = int((í†  - avg_ohaeng) / avg_ohaeng * 5)
                ohaeng_bonus['money'] += stability_bonus
                ohaeng_bonus['love'] += stability_bonus
                ohaeng_bonus['study'] += stability_bonus
                ohaeng_bonus['work'] += stability_bonus

            # ì¼ì£¼ ê°•ì•½(ilju_strength)ë„ ë°˜ì˜
            if saju_data.get('ilju_strength'):
                strength = saju_data['ilju_strength']
                if strength == 'ê°•':
                    base += 5  # ì¼ì£¼ê°€ ê°•í•˜ë©´ ê¸°ë³¸ ìš´ì„¸ ìƒìŠ¹
                elif strength == 'ì•½':
                    base -= 3  # ì¼ì£¼ê°€ ì•½í•˜ë©´ ê¸°ë³¸ ìš´ì„¸ ì†Œí­ í•˜ë½

        # ì˜¤í–‰ ë³´ë„ˆìŠ¤ ì ìš© (ë²”ìœ„ ì œí•œ: -15 ~ +15)
        ohaeng_bonus = {k: max(-15, min(15, v)) for k, v in ohaeng_bonus.items()}

        money = max(50, min(100, base + random.randint(-10, 15) + ohaeng_bonus['money']))
        love = max(50, min(100, base + random.randint(-15, 20) + ohaeng_bonus['love']))
        study = max(50, min(100, base + random.randint(-10, 10) + ohaeng_bonus['study']))
        work = max(50, min(100, base + random.randint(-10, 15) + ohaeng_bonus['work']))

        # ì´ìš´ì€ 4ê°œ ìš´ì„¸ì˜ í‰ê· 
        total = round((money + love + study + work) / 4)

        return {
            'total': total,
            'money': money,
            'love': love,
            'study': study,
            'work': work,
        }
    
    def _generate_fortune_texts(self, scores: Dict, zodiac_sign: str, chinese_zodiac: str) -> Dict:
        """ê° ìš´ë³„ ìƒì„¸ í…ìŠ¤íŠ¸ ìƒì„± (250-300ì)"""
        texts = {}
        
        # ì¢…í•©ìš´
        total_score = scores['total']
        if total_score >= 80:
            texts['total'] = (
                f"ì˜¤ëŠ˜ì€ {zodiac_sign}ì¸ ë‹¹ì‹ ì—ê²Œ ì •ë§ íŠ¹ë³„í•œ í•˜ë£¨ê°€ ë  ê²ƒì…ë‹ˆë‹¤. "
                f"í‰ì†Œ ê³ ë¯¼í•˜ë˜ ì¼ë“¤ì´ ìˆ ìˆ  í’€ë¦¬ë©°, ì£¼ë³€ ì‚¬ëŒë“¤ë¡œë¶€í„° ì¢‹ì€ ì†Œì‹ì„ ë“£ê²Œ ë  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. "
                f"ì˜¤ì „ ì‹œê°„ëŒ€ì—ëŠ” ì¤‘ìš”í•œ ê²°ì •ì„ ë‚´ë¦¬ê¸°ì— ìµœì ì˜ íƒ€ì´ë°ì´ë©°, ë‹¹ì‹ ì˜ ì§ê°ì´ íŠ¹íˆ ì˜ˆë¦¬í•´ì§ˆ ê²ƒì…ë‹ˆë‹¤. "
                f"ì˜¤í›„ì—ëŠ” ìƒˆë¡œìš´ ì¸ì—°ì„ ë§Œë‚˜ê±°ë‚˜ ê¸°ì¡´ ê´€ê³„ê°€ ë”ìš± ëˆë…í•´ì§ˆ ìˆ˜ ìˆëŠ” ê¸°íšŒê°€ ì°¾ì•„ì˜¬ ê²ƒì…ë‹ˆë‹¤. "
                f"ìì‹ ê°ì„ ê°€ì§€ê³  ì ê·¹ì ìœ¼ë¡œ í–‰ë™í•œë‹¤ë©´ ì˜ˆìƒë³´ë‹¤ í›¨ì”¬ ì¢‹ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. "
                f"íŠ¹íˆ ì˜¤ëŠ˜ì€ {chinese_zodiac}ì˜ ê¸°ìš´ì´ ê°•í•˜ê²Œ ì‘ìš©í•˜ì—¬ í‰ì†Œë³´ë‹¤ ë” ë§ì€ í–‰ìš´ì´ ë”°ë¥¼ ê²ƒì…ë‹ˆë‹¤."
            )
        elif total_score >= 60:
            texts['total'] = (
                f"{chinese_zodiac}ì¸ ë‹¹ì‹ ì˜ ì˜¤ëŠ˜ì€ í‰ì˜¨í•˜ê³  ì•ˆì •ì ì¸ ê¸°ìš´ì´ ê°ë•ë‹ˆë‹¤. "
                f"í° ë³€í™”ë³´ë‹¤ëŠ” ì¼ìƒì˜ ì†Œì†Œí•œ í–‰ë³µì„ ëŠë‚„ ìˆ˜ ìˆëŠ” ë‚ ì´ ë  ê²ƒì´ë©°, ê°€ì¡±ì´ë‚˜ ì¹œêµ¬ë“¤ê³¼ì˜ ë”°ëœ»í•œ ì‹œê°„ì´ ë‹¹ì‹ ì—ê²Œ ìœ„ì•ˆì„ ì¤„ ê²ƒì…ë‹ˆë‹¤. "
                f"ì—…ë¬´ë‚˜ í•™ì—…ì—ì„œëŠ” ê¾¸ì¤€í•œ ë…¸ë ¥ì´ ì„œì„œíˆ ê²°ì‹¤ì„ ë§ºê¸° ì‹œì‘í•˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. "
                f"ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ë¬´ë¦¬í•˜ì§€ ë§ê³  ìì‹ ì˜ í˜ì´ìŠ¤ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì°¨ê·¼ì°¨ê·¼ ì¼ì„ ì§„í–‰í•´ ë‚˜ê°€ì„¸ìš”. "
                f"ê±´ê°• ê´€ë¦¬ì—ë„ ì‹ ê²½ì„ ì“°ë©´ ì¢‹ì„ ë‚ ì´ë©°, ê°€ë²¼ìš´ ìš´ë™ì´ë‚˜ ì‚°ì±…ì´ ì‹¬ì‹ ì˜ ì•ˆì •ì— ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤."
            )
        elif total_score >= 40:
            texts['total'] = (
                f"ì˜¤ëŠ˜ì€ ì¡°ê¸ˆ ì‹ ì¤‘í•˜ê²Œ í–‰ë™í•˜ëŠ” ê²ƒì´ í•„ìš”í•œ ë‚ ì…ë‹ˆë‹¤. "
                f"{zodiac_sign}ì˜ ê¸°ìš´ì´ ë‹¤ì†Œ ì•½í•´ì ¸ ìˆì–´ í‰ì†Œë³´ë‹¤ ì§‘ì¤‘ë ¥ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
                f"ì¤‘ìš”í•œ ê²°ì •ì€ í•˜ë£¨ ì´í‹€ ë¯¸ë£¨ëŠ” ê²ƒì´ í˜„ëª…í•˜ë©°, ì¶©ë¶„í•œ ì‹œê°„ì„ ê°–ê³  ê¹Šì´ ìˆê²Œ ê³ ë¯¼í•´ë³´ì„¸ìš”. "
                f"ëŒ€ì¸ê´€ê³„ì—ì„œëŠ” ì˜¤í•´ê°€ ìƒê¸°ì§€ ì•Šë„ë¡ ë§ê³¼ í–‰ë™ì— íŠ¹ë³„íˆ ì£¼ì˜ë¥¼ ê¸°ìš¸ì´ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. "
                f"ì‘ì€ ì‹¤ìˆ˜ê°€ í° ë¬¸ì œë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë‹ˆ í‰ì†Œë³´ë‹¤ ê¼¼ê¼¼í•˜ê²Œ ì¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”. "
                f"ì˜¤ëŠ˜ì€ ìƒˆë¡œìš´ ì‹œë„ë³´ë‹¤ëŠ” ê¸°ì¡´ì— í•˜ë˜ ì¼ì— ì¶©ì‹¤í•˜ëŠ” ê²ƒì´ ë” ì¢‹ì€ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ê²ƒì…ë‹ˆë‹¤."
            )
        else:
            texts['total'] = (
                f"ì˜¤ëŠ˜ì€ ì¶©ë¶„í•œ íœ´ì‹ì´ í•„ìš”í•œ ë‚ ì…ë‹ˆë‹¤. {chinese_zodiac}ì˜ ìš´ì„¸ê°€ ì €ì¡°í•œ ìƒíƒœì´ë¯€ë¡œ ë¬´ë¦¬í•˜ì§€ ë§ˆì„¸ìš”. "
                f"í° ê³„íšì´ë‚˜ ì¤‘ìš”í•œ ì•½ì†ì€ ê°€ëŠ¥í•œ í•œ ë‹¤ë¥¸ ë‚ ë¡œ ë¯¸ë£¨ëŠ” ê²ƒì´ ì¢‹ê² ìŠµë‹ˆë‹¤. "
                f"ëª¸ê³¼ ë§ˆìŒì´ ì§€ì³ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì¶©ë¶„í•œ ìˆ˜ë©´ê³¼ ì˜ì–‘ ì„­ì·¨ì— ì‹ ê²½ ì“°ì„¸ìš”. "
                f"ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ” ìƒí™©ì€ ìµœëŒ€í•œ í”¼í•˜ê³ , í˜¼ìë§Œì˜ ì‹œê°„ì„ ê°€ì§€ë©° ë§ˆìŒì„ ì •ë¦¬í•´ë³´ì„¸ìš”. "
                f"ì˜¤ëŠ˜ì˜ íœ´ì‹ì´ ë‚´ì¼ì˜ í™œë ¥ì´ ë  ê²ƒì´ë‹ˆ ì¡°ê¸‰í•´í•˜ì§€ ë§ˆì‹œê³ , ìì‹ ì„ ìœ„í•œ ì¬ì¶©ì „ì˜ ì‹œê°„ìœ¼ë¡œ í™œìš©í•˜ì„¸ìš”."
            )
        
        # ì¬ë¬¼ìš´
        money_score = scores['money']
        if money_score >= 80:
            texts['money'] = (
                "ì¬ë¬¼ìš´ì´ í¬ê²Œ ìƒìŠ¹í•˜ëŠ” ë§¤ìš° ì¢‹ì€ ë‚ ì…ë‹ˆë‹¤. ì˜ˆìƒì¹˜ ëª»í•œ ìˆ˜ì…ì´ë‚˜ ë³´ë„ˆìŠ¤, ìš©ëˆ ë“±ì˜ íš¡ì¬ìˆ˜ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
                "íˆ¬ìë‚˜ ì‚¬ì—…ì— ê´€ì‹¬ì´ ìˆì—ˆë‹¤ë©´ ì˜¤ëŠ˜ êµ¬ì²´ì ì¸ ê³„íšì„ ì„¸ì›Œë³´ëŠ” ê²ƒë„ ì¢‹ìŠµë‹ˆë‹¤. "
                "ë³µê¶Œì´ë‚˜ ê²½í’ˆ ì‘ëª¨ì—ë„ ìš´ì´ ë”°ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì†Œì†Œí•œ ì‹œë„ë¥¼ í•´ë³´ì„¸ìš”. "
                "ë‹¤ë§Œ ê³¼ë„í•œ ìš•ì‹¬ì€ ì˜¤íˆë ¤ ì†ì‹¤ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìœ¼ë‹ˆ ì ë‹¹í•œ ì„ ì—ì„œ ë§Œì¡±í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. "
                "ì˜¤ëŠ˜ ë“¤ì–´ì˜¨ ì¬ë¬¼ì€ ë¯¸ë˜ë¥¼ ìœ„í•´ ì¼ë¶€ëŠ” ì €ì¶•í•˜ëŠ” ê²ƒì´ ì¢‹ê² ìŠµë‹ˆë‹¤. "
                "íŠ¹íˆ ì˜¤í›„ 3ì‹œì—ì„œ 5ì‹œ ì‚¬ì´ì— ê¸ˆì „ ê´€ë ¨ ì¢‹ì€ ì†Œì‹ì„ ë“¤ì„ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤."
            )
        elif money_score >= 60:
            texts['money'] = (
                "ì¬ë¬¼ìš´ì´ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ëŠ” ë¬´ë‚œí•œ ë‚ ì…ë‹ˆë‹¤. í° ìˆ˜ì…ì€ ì—†ì§€ë§Œ ì˜ˆìƒì¹˜ ëª»í•œ ì§€ì¶œë„ ì—†ì„ ê²ƒì…ë‹ˆë‹¤. "
                "ê³„íšì ì¸ ì†Œë¹„ì™€ ì €ì¶•ì„ ì‹¤ì²œí•˜ê¸°ì— ì¢‹ì€ ì‹œê¸°ì´ë©°, ê°€ê³„ë¶€ë¥¼ ì •ë¦¬í•˜ê±°ë‚˜ ì¬ì • ê³„íšì„ ì„¸ìš°ê¸°ì— ì í•©í•©ë‹ˆë‹¤. "
                "ì‘ì€ ì ˆì•½ì´ í° ë¶€ë¥¼ ë§Œë“ ë‹¤ëŠ” ë§ˆìŒê°€ì§ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ ì§€ì¶œì„ ì¤„ì´ë©´ ì¢‹ì€ ê²°ê³¼ê°€ ìˆì„ ê²ƒì…ë‹ˆë‹¤. "
                "íˆ¬ìë³´ë‹¤ëŠ” ì•ˆì •ì ì¸ ì €ì¶•ì— ì§‘ì¤‘í•˜ëŠ” ê²ƒì´ ìœ ë¦¬í•˜ë©°, ì¥ê¸°ì ì¸ ì¬í…Œí¬ ê³µë¶€ë¥¼ ì‹œì‘í•´ë³´ëŠ” ê²ƒë„ ì¢‹ê² ìŠµë‹ˆë‹¤. "
                "ë™ë£Œë‚˜ ì¹œêµ¬ì™€ ê¸ˆì „ ê±°ë˜ëŠ” ê°€ëŠ¥í•œ í”¼í•˜ëŠ” ê²ƒì´ ê´€ê³„ë¥¼ ìœ„í•´ì„œë„ ì¢‹ìŠµë‹ˆë‹¤. "
                "ì˜¤ëŠ˜ì€ ë¯¸ë˜ì˜ ì¬ì • ê³„íšì„ ì°¨ë¶„íˆ ê²€í† í•´ë³´ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”."
            )
        else:
            texts['money'] = (
                "ì¬ë¬¼ìš´ì´ ë‹¤ì†Œ ì €ì¡°í•œ ë‚ ì´ë‹ˆ ì§€ì¶œ ê´€ë¦¬ì— íŠ¹ë³„íˆ ì‹ ê²½ ì¨ì•¼ í•©ë‹ˆë‹¤. "
                "ì¶©ë™êµ¬ë§¤ë‚˜ ë¶ˆí•„ìš”í•œ ì§€ì¶œì„ ìì œí•˜ê³ , ê¼­ í•„ìš”í•œ ê²ƒë§Œ êµ¬ì…í•˜ë„ë¡ í•˜ì„¸ìš”. "
                "íˆ¬ìë‚˜ ë„ë°•ì„± ê²Œì„ì€ ì ˆëŒ€ í”¼í•´ì•¼ í•˜ë©°, ê¸ˆì „ ëŒ€ì¶œì´ë‚˜ ë³´ì¦ë„ ì„œì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. "
                "ì˜¤ëŠ˜ì€ ëˆì„ ì“°ëŠ” ê²ƒë³´ë‹¤ ë²„ëŠ” ë°©ë²•ì„ ê³ ë¯¼í•˜ê³ , ë¶€ì—…ì´ë‚˜ ìƒˆë¡œìš´ ìˆ˜ì…ì›ì„ ì°¾ì•„ë³´ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”. "
                "ì‘ì€ ì•¡ìˆ˜ë¼ë„ ì €ì¶•í•˜ëŠ” ìŠµê´€ì„ ê¸°ë¥´ë©´ ì•ìœ¼ë¡œì˜ ì¬ë¬¼ìš´ ìƒìŠ¹ì— ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤. "
                "ì–´ë ¤ìš´ ì‹œê¸°ëŠ” ê³§ ì§€ë‚˜ê°ˆ ê²ƒì´ë‹ˆ ë„ˆë¬´ ê±±ì •í•˜ì§€ ë§ˆì‹œê³  ì°¨ë¶„íˆ ëŒ€ì²˜í•˜ì„¸ìš”."
            )
        
        # ì—°ì• ìš´
        love_score = scores['love']
        if love_score >= 80:
            texts['love'] = (
                "ì—°ì• ìš´ì´ ìµœê³ ì¡°ì— ë‹¬í•˜ëŠ” í™˜ìƒì ì¸ ë‚ ì…ë‹ˆë‹¤. ì‹±ê¸€ì´ë¼ë©´ ìš´ëª…ì ì¸ ë§Œë‚¨ì´ë‚˜ ì´ìƒí˜•ì— ê°€ê¹Œìš´ ì‚¬ëŒì„ ë§Œë‚  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. "
                "ì—°ì¸ì´ ìˆë‹¤ë©´ ì„œë¡œì˜ ì‚¬ë‘ì„ ë”ìš± ê¹Šì´ í™•ì¸í•˜ê³ , ê´€ê³„ê°€ í•œ ë‹¨ê³„ ë°œì „í•˜ëŠ” ê³„ê¸°ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
                "í‰ì†Œ ê³ ë°±ì„ ë§ì„¤ì˜€ë‹¤ë©´ ì˜¤ëŠ˜ì´ ìµœì ì˜ íƒ€ì´ë°ì´ë‹ˆ ìš©ê¸°ë¥¼ ë‚´ë³´ì„¸ìš”. "
                "ë°ì´íŠ¸ë¥¼ ê³„íší•˜ê³  ìˆë‹¤ë©´ ë¡œë§¨í‹±í•œ ë¶„ìœ„ê¸°ì˜ ì¥ì†Œë¥¼ ì„ íƒí•˜ë©´ ë”ìš± ì¢‹ì€ ì¶”ì–µì„ ë§Œë“¤ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. "
                "ìƒëŒ€ë°©ì— ëŒ€í•œ ì‘ì€ ë°°ë ¤ì™€ ê´€ì‹¬ í‘œí˜„ì´ í° ê°ë™ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆëŠ” ë‚ ì…ë‹ˆë‹¤. "
                "íŠ¹íˆ ì €ë… 7ì‹œì—ì„œ 9ì‹œ ì‚¬ì´ê°€ ì‚¬ë‘ì˜ ê¸°ìš´ì´ ê°€ì¥ ê°•í•œ ì‹œê°„ëŒ€ì…ë‹ˆë‹¤."
            )
        elif love_score >= 60:
            texts['love'] = (
                "ì—°ì• ìš´ì´ í‰ì˜¨í•˜ê²Œ ìœ ì§€ë˜ëŠ” ì•ˆì •ì ì¸ ë‚ ì…ë‹ˆë‹¤. í° ë³€í™”ë³´ë‹¤ëŠ” ì¼ìƒì˜ ì†Œì†Œí•œ ì• ì • í‘œí˜„ì´ ì¤‘ìš”í•œ ì‹œê¸°ì…ë‹ˆë‹¤. "
                "ì—°ì¸ê³¼ í•¨ê»˜ ì¡°ìš©í•œ ë°ì´íŠ¸ë¥¼ ì¦ê¸°ê±°ë‚˜, ì§„ì†”í•œ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ë©° ì„œë¡œë¥¼ ë” ê¹Šì´ ì´í•´í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. "
                "ì‹±ê¸€ì´ë¼ë©´ ê¸‰í•˜ê²Œ ì¸ì—°ì„ ì°¾ê¸°ë³´ë‹¤ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ë§Œë‚¨ì„ ê¸°ë‹¤ë¦¬ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. "
                "ì£¼ë³€ ì‚¬ëŒë“¤ê³¼ì˜ ëª¨ì„ì´ë‚˜ ì·¨ë¯¸ í™œë™ì„ í†µí•´ ìƒˆë¡œìš´ ì¸ì—°ì„ ë§Œë‚  ê°€ëŠ¥ì„±ë„ ìˆìŠµë‹ˆë‹¤. "
                "ì—°ì• ë³´ë‹¤ëŠ” ìš°ì •ì„ ìŒ“ëŠ” ë° ì§‘ì¤‘í•˜ë©´ ë‚˜ì¤‘ì— ì¢‹ì€ ì¸ì—°ìœ¼ë¡œ ë°œì „í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. "
                "ì˜¤ëŠ˜ì€ ìì‹ ì˜ ë§¤ë ¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ë°œì‚°í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•œ ë‚ ì…ë‹ˆë‹¤."
            )
        else:
            texts['love'] = (
                "ì—°ì• ìš´ì´ ë‹¤ì†Œ ì¹¨ì²´ëœ ë‚ ì´ë‹ˆ ê´€ê³„ì—ì„œ ì‹ ì¤‘í•œ íƒœë„ê°€ í•„ìš”í•©ë‹ˆë‹¤. "
                "ì‚¬ì†Œí•œ ì˜¤í•´ë‚˜ ë‹¤íˆ¼ì´ ìƒê¸¸ ìˆ˜ ìˆìœ¼ë‹ˆ ë§ê³¼ í–‰ë™ì— ì£¼ì˜í•˜ê³ , ìƒëŒ€ë°©ì˜ ì…ì¥ì„ ì´í•´í•˜ë ¤ëŠ” ë…¸ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤. "
                "ì—°ì¸ê³¼ì˜ ê´€ê³„ì—ì„œ ì ì‹œ ê±°ë¦¬ë¥¼ ë‘ê³  ìƒê°í•  ì‹œê°„ì„ ê°–ëŠ” ê²ƒë„ ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
                "ì‹±ê¸€ì´ë¼ë©´ ì˜¤ëŠ˜ì€ ì—°ì• ë³´ë‹¤ëŠ” ìê¸° ìì‹ ì—ê²Œ ì§‘ì¤‘í•˜ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”. "
                "ìê¸° ê³„ë°œì´ë‚˜ ì·¨ë¯¸ í™œë™ì— ëª°ë‘í•˜ë‹¤ ë³´ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ë§¤ë ¥ì´ ìƒìŠ¹í•˜ê³  ì¢‹ì€ ì¸ì—°ì„ ë§Œë‚  ì¤€ë¹„ê°€ ë  ê²ƒì…ë‹ˆë‹¤. "
                "ì–´ë ¤ìš´ ì‹œê¸°ë¥¼ ì˜ ê·¹ë³µí•˜ë©´ ë” ì¢‹ì€ ì‚¬ë‘ì´ ì°¾ì•„ì˜¬ ê²ƒì…ë‹ˆë‹¤."
            )
        
        # í•™ì—…ìš´
        study_score = scores['study']
        if study_score >= 80:
            texts['study'] = (
                "í•™ì—…ìš´ì´ ìµœìƒì˜ ìƒíƒœì¸ ë‚ ì…ë‹ˆë‹¤. ì§‘ì¤‘ë ¥ê³¼ ì´í•´ë ¥ì´ í¬ê²Œ í–¥ìƒë˜ì–´ ê³µë¶€í•œ ë‚´ìš©ì´ ë¨¸ë¦¿ì†ì— ì™ì™ ë“¤ì–´ì˜¬ ê²ƒì…ë‹ˆë‹¤. "
                "ì‹œí—˜ì„ ì•ë‘ê³  ìˆë‹¤ë©´ ì˜¤ëŠ˜ ì§‘ì¤‘ì ìœ¼ë¡œ ê³µë¶€í•˜ë©´ ì˜ˆìƒë³´ë‹¤ ì¢‹ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
                "ìƒˆë¡œìš´ ë¶„ì•¼ë¥¼ ê³µë¶€í•˜ê¸° ì‹œì‘í•˜ê¸°ì—ë„ ìµœì ì˜ ë‚ ì´ë©°, ì–´ë ¤ì› ë˜ ê°œë…ë„ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. "
                "ë„ì„œê´€ì´ë‚˜ ì¡°ìš©í•œ ì¹´í˜ì—ì„œ ê³µë¶€í•˜ë©´ íš¨ìœ¨ì´ ë”ìš± ë†’ì•„ì§ˆ ê²ƒì…ë‹ˆë‹¤. "
                "ì˜¤ëŠ˜ ê³µë¶€í•œ ë‚´ìš©ì€ ì˜¤ë˜ ê¸°ì–µì— ë‚¨ì„ ê²ƒì´ë‹ˆ ì¤‘ìš”í•œ ë‚´ìš© ìœ„ì£¼ë¡œ í•™ìŠµí•˜ëŠ” ê²ƒì´ ì¢‹ê² ìŠµë‹ˆë‹¤. "
                "íŠ¹íˆ ì˜¤ì „ 10ì‹œì—ì„œ 12ì‹œ ì‚¬ì´ê°€ ê°€ì¥ ì§‘ì¤‘ë ¥ì´ ë†’ì€ ì‹œê°„ëŒ€ì…ë‹ˆë‹¤."
            )
        elif study_score >= 60:
            texts['study'] = (
                "í•™ì—… ë©´ì—ì„œ ê¾¸ì¤€í•œ ì§„ì „ì„ ë³´ì¼ ìˆ˜ ìˆëŠ” ì•ˆì •ì ì¸ ë‚ ì…ë‹ˆë‹¤. "
                "ì–´ë ¤ìš´ ë¬¸ì œì— ë„ì „í•˜ê¸°ë³´ë‹¤ëŠ” ê¸°ì´ˆë¥¼ ë‹¤ì§€ê³  ë³µìŠµí•˜ëŠ” ë° ì§‘ì¤‘í•˜ë©´ ì¢‹ì€ ì„±ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
                "ìŠ¤í„°ë”” ê·¸ë£¹ì´ë‚˜ ë™ë£Œì™€ì˜ í† ë¡ ì„ í†µí•´ ìƒˆë¡œìš´ ê´€ì ê³¼ ì•„ì´ë””ì–´ë¥¼ ì–»ì„ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. "
                "ê³„íšì ìœ¼ë¡œ ì‹œê°„ì„ ë°°ë¶„í•˜ì—¬ ê³µë¶€í•˜ë©´ íš¨ìœ¨ì„±ì„ ë†’ì¼ ìˆ˜ ìˆìœ¼ë©°, ì ì ˆí•œ íœ´ì‹ë„ ìŠì§€ ë§ˆì„¸ìš”. "
                "ì˜¨ë¼ì¸ ê°•ì˜ë‚˜ ì°¸ê³  ìë£Œë¥¼ í™œìš©í•˜ë©´ ë¶€ì¡±í•œ ë¶€ë¶„ì„ ë³´ì™„í•˜ëŠ” ë° ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤. "
                "ì˜¤ëŠ˜ì€ ê¾¸ì¤€í•¨ì´ ê°€ì¥ ì¤‘ìš”í•œ ì—´ì‡ ê°€ ë  ê²ƒì…ë‹ˆë‹¤."
            )
        else:
            texts['study'] = (
                "í•™ì—…ì— ì§‘ì¤‘í•˜ê¸° ì–´ë ¤ìš´ ë‚ ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ë¬´ë¦¬í•˜ì§€ ë§ê³  ê°€ë²¼ìš´ ë³µìŠµ ì •ë„ë¡œ ë§ˆë¬´ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. "
                "ì–´ë ¤ìš´ ê³¼ëª©ë³´ë‹¤ëŠ” ê´€ì‹¬ ìˆëŠ” ë¶„ì•¼ë‚˜ ì‰¬ìš´ ë‚´ìš©ë¶€í„° ì‹œì‘í•˜ì—¬ í•™ìŠµ ë™ê¸°ë¥¼ ìœ ì§€í•˜ì„¸ìš”. "
                "ì˜¤ëŠ˜ì€ ì–‘ë³´ë‹¤ ì§ˆì— ì§‘ì¤‘í•˜ì—¬ í•µì‹¬ ë‚´ìš©ë§Œ ì •ë¦¬í•˜ëŠ” ê²ƒì´ íš¨ê³¼ì ì¼ ê²ƒì…ë‹ˆë‹¤. "
                "ì¶©ë¶„í•œ íœ´ì‹ê³¼ ìˆ˜ë©´ì„ ì·¨í•œ í›„ ë‚´ì¼ ë‹¤ì‹œ ì§‘ì¤‘í•˜ëŠ” ê²ƒì´ ë” ë‚˜ì€ ì„ íƒì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
                "ìš´ë™ì´ë‚˜ ì‚°ì±…ì„ í†µí•´ ë¨¸ë¦¬ë¥¼ ë§‘ê²Œ í•˜ë©´ í•™ìŠµ ëŠ¥ë ¥ì´ ì¡°ê¸ˆì”© íšŒë³µë  ê²ƒì…ë‹ˆë‹¤. "
                "ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì§€ ë§ê³  ì—¬ìœ ë¥¼ ê°€ì§€ê³  ì ‘ê·¼í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤."
            )
        
        # ì§ì¥ìš´
        work_score = scores['work']
        if work_score >= 80:
            texts['work'] = (
                "ì§ì¥ìš´ì´ í¬ê²Œ ìƒìŠ¹í•˜ëŠ” ë‚ ë¡œ ë‹¹ì‹ ì˜ ëŠ¥ë ¥ì´ ì¸ì •ë°›ê³  ì¢‹ì€ í‰ê°€ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
                "ì¤‘ìš”í•œ í”„ë¡œì íŠ¸ë‚˜ ë°œí‘œê°€ ìˆë‹¤ë©´ ìì‹ ê°ì„ ê°€ì§€ê³  ì„í•˜ë©´ ê¸°ëŒ€ ì´ìƒì˜ ì„±ê³¼ë¥¼ ë‚¼ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. "
                "ìƒì‚¬ë‚˜ ë™ë£Œë“¤ê³¼ì˜ ê´€ê³„ë„ ë§¤ìš° ì›ë§Œí•˜ê²Œ ìœ ì§€ë˜ë©°, í˜‘ì—…ì´ í•„ìš”í•œ ì—…ë¬´ì—ì„œ ì‹œë„ˆì§€ë¥¼ ë°œíœ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
                "ìŠ¹ì§„ì´ë‚˜ ì¸ì„¼í‹°ë¸Œ ë“±ì˜ ì¢‹ì€ ì†Œì‹ì„ ë“¤ì„ ê°€ëŠ¥ì„±ë„ ìˆìœ¼ë‹ˆ ê¸°ëŒ€í•´ë„ ì¢‹ìŠµë‹ˆë‹¤. "
                "ì˜¤ëŠ˜ì˜ ì„±ê³¼ëŠ” ì•ìœ¼ë¡œì˜ ì»¤ë¦¬ì–´ì— ì¤‘ìš”í•œ ì „í™˜ì ì´ ë  ìˆ˜ ìˆìœ¼ë‹ˆ ìµœì„ ì„ ë‹¤í•´ ì„í•˜ì„¸ìš”. "
                "íŠ¹íˆ ì˜¤í›„ 2ì‹œì—ì„œ 4ì‹œ ì‚¬ì´ì— ì¤‘ìš”í•œ ê¸°íšŒê°€ ì°¾ì•„ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            )
        elif work_score >= 60:
            texts['work'] = (
                "ì—…ë¬´ê°€ ìˆœì¡°ë¡­ê²Œ ì§„í–‰ë˜ëŠ” í‰ì˜¨í•œ ë‚ ì…ë‹ˆë‹¤. í° ì„±ê³¼ëŠ” ì—†ë”ë¼ë„ ì°©ì‹¤í•˜ê²Œ ë§¡ì€ ì¼ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. "
                "í‰ì†Œ ë¯¸ë¤„ë‘ì—ˆë˜ ì„œë¥˜ ì‘ì—…ì´ë‚˜ ì •ë¦¬ê°€ í•„ìš”í•œ ì—…ë¬´ë¥¼ ì²˜ë¦¬í•˜ê¸°ì— ì¢‹ì€ ì‹œê¸°ì…ë‹ˆë‹¤. "
                "ë™ë£Œë“¤ê³¼ì˜ ì†Œí†µê³¼ í˜‘ì—…ì´ ì›í™œí•˜ê²Œ ì´ë£¨ì–´ì§€ë©°, íŒ€ì›Œí¬ë¥¼ ë°œíœ˜í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. "
                "ìƒˆë¡œìš´ ì•„ì´ë””ì–´ë‚˜ ê°œì„  ì‚¬í•­ì´ ìˆë‹¤ë©´ ìƒì‚¬ì—ê²Œ ì œì•ˆí•´ë³´ëŠ” ê²ƒë„ ì¢‹ì€ ê¸°íšŒê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
                "í‡´ê·¼ í›„ì—ëŠ” ìê¸° ê³„ë°œì„ ìœ„í•œ ì‹œê°„ì„ ê°€ì ¸ë³´ëŠ” ê²ƒë„ ë¯¸ë˜ë¥¼ ìœ„í•´ ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤. "
                "ì˜¤ëŠ˜ì€ ì„±ì‹¤í•¨ê³¼ ê¾¸ì¤€í•¨ì´ ê°€ì¥ ì¤‘ìš”í•œ ë•ëª©ì…ë‹ˆë‹¤."
            )
        else:
            texts['work'] = (
                "ì§ì¥ì—ì„œ ì‘ì€ ì–´ë ¤ì›€ì´ë‚˜ ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ìˆì„ ìˆ˜ ìˆëŠ” ë‚ ì…ë‹ˆë‹¤. "
                "ì¤‘ìš”í•œ ê²°ì •ì´ë‚˜ ìƒˆë¡œìš´ ì‹œë„ëŠ” ë¯¸ë£¨ê³ , ê¸°ì¡´ ì—…ë¬´ì— ì§‘ì¤‘í•˜ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤. "
                "ì‹¤ìˆ˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ í‰ì†Œë³´ë‹¤ ê¼¼ê¼¼íˆ í™•ì¸í•˜ê³ , ì´ì¤‘ ì²´í¬í•˜ëŠ” ìŠµê´€ì„ ê°€ì§€ì„¸ìš”. "
                "ë™ë£Œë‚˜ ìƒì‚¬ì™€ì˜ ì˜ê²¬ ì¶©ëŒì´ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ê°ì •ì ìœ¼ë¡œ ëŒ€ì‘í•˜ì§€ ë§ê³  ëƒ‰ì •ì„ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. "
                "ì˜¤ëŠ˜ì€ ëˆˆì— ë„ëŠ” ì„±ê³¼ë³´ë‹¤ëŠ” ì‹¤ìˆ˜ë¥¼ ì¤„ì´ê³  ì•ˆì •ì ìœ¼ë¡œ í•˜ë£¨ë¥¼ ë§ˆë¬´ë¦¬í•˜ëŠ” ë° ì§‘ì¤‘í•˜ì„¸ìš”. "
                "ì–´ë ¤ìš´ ì‹œê¸°ëŠ” ê³§ ì§€ë‚˜ê°ˆ ê²ƒì´ë‹ˆ ì¸ë‚´ì‹¬ì„ ê°€ì§€ê³  ê²¬ëŒë‚´ì„¸ìš”."
            )
        
        return texts
    
    def _determine_lucky_colors(
        self,
        zodiac_sign: str,
        chinese_zodiac: str,
        today: date,
        fortune_scores: Dict = None
    ) -> List[str]:
        """í–‰ìš´ì˜ ìƒ‰ìƒë“¤ ê²°ì • (ë³„ìë¦¬ + ë  + ë‚ ì§œ + ìš´ì„¸ì ìˆ˜ ê¸°ë°˜)"""
        import hashlib

        # ì‹œë“œ ìƒì„±: ë³„ìë¦¬ + ë  + ë‚ ì§œ ì¡°í•©ìœ¼ë¡œ ë§¤ì¼ ë‹¤ë¥¸ ê²°ê³¼
        seed_string = f"{zodiac_sign}_{chinese_zodiac}_{today.isoformat()}"
        seed_hash = int(hashlib.md5(seed_string.encode()).hexdigest(), 16)

        # ë³„ìë¦¬ ìƒ‰ìƒ í’€
        star_colors = self.STAR_SIGN_COLORS.get(zodiac_sign, self.ALL_COLORS[:5])

        # ë  ìƒ‰ìƒ í’€
        zodiac_colors = self.CHINESE_ZODIAC_COLORS.get(chinese_zodiac, [])

        # í›„ë³´ ìƒ‰ìƒ í’€ êµ¬ì„± (ë³„ìë¦¬ + ë  ìƒ‰ìƒ í•©ì¹˜ê¸°)
        candidate_colors = list(star_colors) + list(zodiac_colors)

        # ìš´ì„¸ ì ìˆ˜ê°€ ìˆìœ¼ë©´ ì ìˆ˜ì— ë”°ë¼ ìƒ‰ìƒ ê°€ì¤‘ì¹˜ ì¡°ì •
        if fortune_scores:
            total_score = fortune_scores.get('total', 50)

            # ìš´ì„¸ê°€ ì¢‹ìœ¼ë©´ ë°ì€ ìƒ‰ìƒ ì¶”ê°€
            if total_score >= 80:
                candidate_colors.extend(['ê¸ˆìƒ‰', 'ë…¸ë€ìƒ‰', 'í°ìƒ‰'])
            elif total_score >= 60:
                candidate_colors.extend(['í•˜ëŠ˜ìƒ‰', 'ë¶„í™ìƒ‰'])
            elif total_score < 40:
                # ìš´ì„¸ê°€ ë‚®ìœ¼ë©´ ì•ˆì •ì ì¸ ìƒ‰ìƒ ì¶”ê°€
                candidate_colors.extend(['ë‚¨ìƒ‰', 'íšŒìƒ‰', 'ë² ì´ì§€ìƒ‰'])

        # ì¤‘ë³µ ì œê±°
        candidate_colors = list(dict.fromkeys(candidate_colors))

        # ë‚ ì§œ ê¸°ë°˜ ì‹œë“œë¡œ 3ê°œ ì„ íƒ (ê°™ì€ ë‚ ì§œë©´ ê°™ì€ ê²°ê³¼)
        selected_colors = []
        for i in range(3):
            if not candidate_colors:
                break
            # ì‹œë“œ + ì¸ë±ìŠ¤ë¡œ ì„ íƒ
            idx = (seed_hash + i * 7) % len(candidate_colors)
            selected_colors.append(candidate_colors[idx])
            candidate_colors.pop(idx)  # ì¤‘ë³µ ì„ íƒ ë°©ì§€

        # 3ê°œ ë¯¸ë§Œì´ë©´ ì „ì²´ í’€ì—ì„œ ë³´ì¶©
        if len(selected_colors) < 3:
            remaining = [c for c in self.ALL_COLORS if c not in selected_colors]
            for i in range(3 - len(selected_colors)):
                if remaining:
                    idx = (seed_hash + i * 13) % len(remaining)
                    selected_colors.append(remaining[idx])
                    remaining.pop(idx)

        return selected_colors if selected_colors else ['íŒŒë€ìƒ‰', 'ì´ˆë¡ìƒ‰', 'ë…¸ë€ìƒ‰']

    def _generate_lucky_lotto_numbers(
        self,
        birth_date: date,
        today: date,
        fortune_scores: Dict = None,
        gender: str = None,
        user_id: int = None,
        session_key: str = None
    ) -> List[int]:
        """ê°œì¸ë³„ í–‰ìš´ì˜ ë¡œë˜ ë²ˆí˜¸ ìƒì„± (user_id ë˜ëŠ” session_key ê¸°ë°˜)"""
        import hashlib

        # ì„±ë³„ ìˆ«ì ë³€í™˜
        gender_num = 1 if gender == 'M' else 2 if gender == 'F' else 0

        # ì‚¬ìš©ì ì‹ë³„ì ê²°ì •: user_id ìš°ì„ , ì—†ìœ¼ë©´ session_key
        if user_id:
            user_identifier = f"user_{user_id}"
        elif session_key:
            user_identifier = f"session_{session_key}"
        else:
            import uuid
            user_identifier = f"random_{uuid.uuid4()}"

        # ì‹œë“œ ìƒì„±: ì‚¬ìš©ìì‹ë³„ì + ì˜¤ëŠ˜ë‚ ì§œ + ìƒë…„ì›”ì¼ + ì„±ë³„
        # ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” ë¸Œë¼ìš°ì € ë°”ë€Œì–´ë„ ê°™ì€ ë²ˆí˜¸, ë¹„ë¡œê·¸ì¸ì€ ì„¸ì…˜ ê¸°ë°˜
        birth_num = birth_date.year * 10000 + birth_date.month * 100 + birth_date.day
        base_seed = f"lotto_{user_identifier}_{today.isoformat()}_{birth_num}_{gender_num}"

        # ìˆœìˆ˜ í•´ì‹œ ê¸°ë°˜ìœ¼ë¡œ 6ê°œ ê³ ìœ  ë²ˆí˜¸ ì„ íƒ (random ëª¨ë“ˆ ë¯¸ì‚¬ìš©)
        selected = []
        attempt = 0
        while len(selected) < 6 and attempt < 100:
            # ê° ë²ˆí˜¸ë§ˆë‹¤ ë‹¤ë¥¸ í•´ì‹œ ìƒì„±
            seed_string = f"{base_seed}_num{attempt}"
            hash_value = int(hashlib.sha256(seed_string.encode()).hexdigest(), 16)
            num = (hash_value % 45) + 1  # 1-45 ë²”ìœ„

            if num not in selected:
                selected.append(num)
            attempt += 1

        return sorted(selected)

    def _determine_lucky_item(self, zodiac_sign: str, today: date, user_id: int = None, session_key: str = None, lucky_colors: List[str] = None, fortune_score: int = 70, fortune_scores: Dict = None) -> Dict:
        """í–‰ìš´ì˜ ì•„ì´í…œ ê²°ì • - ì ìˆ˜ëŒ€ë³„ 6ê°œ ì•„ì´í…œ, ë‚®ì€ ìš´ 2ê°œ ì¡°í•©(4C2=6)ìœ¼ë¡œ ì„ íƒ"""
        import hashlib

        # ë‚®ì€ ìš´ 2ê°œ ì¡°í•©ë³„ ì¸ë±ìŠ¤ ë§¤í•‘ (4C2 = 6ê°€ì§€)
        # 0: ì¬ë¬¼+ì• ì •, 1: ì¬ë¬¼+í•™ì—…, 2: ì¬ë¬¼+ì§ì¥, 3: ì• ì •+í•™ì—…, 4: ì• ì •+ì§ì¥, 5: í•™ì—…+ì§ì¥
        combo_to_index = {
            ('love', 'money'): 0,
            ('money', 'study'): 1,
            ('money', 'work'): 2,
            ('love', 'study'): 3,
            ('love', 'work'): 4,
            ('study', 'work'): 5,
        }

        # ê³ ë“ì (80+): ì ê·¹ì /í™œë™ì  ì•„ì´í…œ 6ê°œ
        high_score_items = [
            ('ë¯¸ë‹ˆ í–¥ìˆ˜', 'ğŸŒ¸', 'ì¬ë¬¼ìš´', 'ì• ì •ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ë¯¸ë‹ˆ í–¥ìˆ˜ì…ë‹ˆë‹¤. ì€ì€í•œ í–¥ê¸°ëŠ” ì£¼ë³€ ì‚¬ëŒë“¤ì—ê²Œ í˜¸ê°ì„ ì£¼ì–´ ì†Œì¤‘í•œ ì¸ì—°ì„ ë§ºê²Œ í•´ì£¼ê³ , ì¢‹ì€ ê¸°íšŒë„ ìì—°ìŠ¤ëŸ½ê²Œ ì°¾ì•„ì˜¤ê²Œ í•©ë‹ˆë‹¤. ìì‹ ê° ìˆëŠ” í•˜ë£¨ë¥¼ ë³´ë‚´ë©° ì ê·¹ì ìœ¼ë¡œ í–‰ë™í•´ë³´ì„¸ìš”.'),
            ('ëª…í•¨ì§€ê°‘', 'ğŸ’¼', 'ì¬ë¬¼ìš´', 'í•™ì—…ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ëª…í•¨ì§€ê°‘ì…ë‹ˆë‹¤. ì²´ê³„ì ìœ¼ë¡œ ì •ë¦¬í•˜ëŠ” ìŠµê´€ì€ ì—…ë¬´ì™€ í•™ìŠµ íš¨ìœ¨ì„ ë†’ì—¬ì£¼ê³ , ì¬ì • ê´€ë¦¬ ëŠ¥ë ¥ë„ í•¨ê»˜ í–¥ìƒì‹œì¼œ ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ ê³„íšì„ ì„¸ìš°ê³  ì°¨ê·¼ì°¨ê·¼ ì‹¤ì²œí•´ë³´ì„¸ìš”.'),
            ('ì†ëª©ì‹œê³„', 'âŒš', 'ì¬ë¬¼ìš´', 'ì§ì¥ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ì†ëª©ì‹œê³„ì…ë‹ˆë‹¤. ì‹œê°„ì„ ì†Œì¤‘íˆ ì—¬ê¸°ëŠ” ë‹¹ì‹ ì—ê²Œ ì†ëª©ì‹œê³„ëŠ” ì„±ì‹¤í•¨ê³¼ ì‹ ë¢°ë¥¼ ìƒì§•í•©ë‹ˆë‹¤. ì •í™•í•œ ì‹œê°„ ê´€ë¦¬ê°€ ì¢‹ì€ ì„±ê³¼ì™€ ë³´ìƒìœ¼ë¡œ ì´ì–´ì§ˆ ê²ƒì…ë‹ˆë‹¤.'),
            ('ë¯¸ë‹ˆ í‚¤ë§', 'ğŸ”‘', 'ì• ì •ìš´', 'í•™ì—…ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ë¯¸ë‹ˆ í‚¤ë§ì…ë‹ˆë‹¤. ìƒˆë¡œìš´ ë¬¸ì„ ì—¬ëŠ” ì—´ì‡ ì²˜ëŸ¼, í‚¤ë§ì€ ì¢‹ì€ ì¸ì—°ê³¼ ìƒˆë¡œìš´ ë°°ì›€ì˜ ê¸°íšŒë¥¼ ì—´ì–´ì¤ë‹ˆë‹¤. ì—´ë¦° ë§ˆìŒìœ¼ë¡œ í•˜ë£¨ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.'),
            ('ìŠ¤ì¹´í”„', 'ğŸ§£', 'ì• ì •ìš´', 'ì§ì¥ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ìŠ¤ì¹´í”„ì…ë‹ˆë‹¤. ìš°ì•„í•œ ìŠ¤ì¹´í”„ëŠ” ë‹¹ì‹ ì˜ ë§¤ë ¥ì„ í•œì¸µ ë‹ë³´ì´ê²Œ í•˜ì—¬ ì¢‹ì€ ì²«ì¸ìƒì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤. ëŒ€ì¸ê´€ê³„ê°€ ì›ë§Œí•´ì§€ê³  ì¢‹ì€ ì¼ì´ ìƒê¸¸ ê²ƒì…ë‹ˆë‹¤.'),
            ('ë³¼íœ', 'ğŸ–Šï¸', 'í•™ì—…ìš´', 'ì§ì¥ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ë³¼íœì…ë‹ˆë‹¤. ê¸°ë¡í•˜ëŠ” ìŠµê´€ì€ í©ì–´ì§„ ìƒê°ì„ ì •ë¦¬í•˜ê³  ì¢‹ì€ ì•„ì´ë””ì–´ë¥¼ ë– ì˜¬ë¦¬ê²Œ í•©ë‹ˆë‹¤. ì˜¤ëŠ˜ ë– ì˜¤ë¥´ëŠ” ì˜ê°ì„ ë†“ì¹˜ì§€ ë§ê³  ê¸°ë¡í•´ë³´ì„¸ìš”.'),
        ]

        # ì¤‘ê°„ì ìˆ˜(60-79): ì•ˆì •ì /ê· í˜• ì•„ì´í…œ 6ê°œ
        mid_score_items = [
            ('ì†ìˆ˜ê±´', 'ğŸ¤', 'ì¬ë¬¼ìš´', 'ì• ì •ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ì†ìˆ˜ê±´ì…ë‹ˆë‹¤. ì •ì„±ì´ ë‹´ê¸´ ì†ìˆ˜ê±´ì€ ë”°ëœ»í•œ ë§ˆìŒì„ ì „í•´ ì†Œì¤‘í•œ ì¸ì—°ì„ ë”ìš± ê¹Šê²Œ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤. ì‘ì€ ë°°ë ¤ê°€ í° í–‰ìš´ìœ¼ë¡œ ëŒì•„ì˜¬ ê²ƒì…ë‹ˆë‹¤.'),
            ('ë‹¤ì´ì–´ë¦¬', 'ğŸ“”', 'ì¬ë¬¼ìš´', 'í•™ì—…ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ë‹¤ì´ì–´ë¦¬ì…ë‹ˆë‹¤. ê¼¼ê¼¼í•˜ê³  ê³„íšì ì¸ ë‹¹ì‹ ì—ê²Œ ë‹¤ì´ì–´ë¦¬ëŠ” ê·¸ ëŠ¥ë ¥ì„ ë”ìš± ë°œíœ˜í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ í•  ì¼ ëª©ë¡ì„ ì‘ì„±í•˜ê³  ê³„íšëŒ€ë¡œ ì‹¤ì²œí•œë‹¤ë©´ ì„±ì·¨ê°ì„ ì–»ì„ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.'),
            ('ì¹´ë“œì§€ê°‘', 'ğŸ’³', 'ì¬ë¬¼ìš´', 'ì§ì¥ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ì¹´ë“œì§€ê°‘ì…ë‹ˆë‹¤. ê¹”ë”í•˜ê²Œ ì •ë¦¬ëœ ì¹´ë“œì§€ê°‘ì€ ì²´ê³„ì ì¸ ê¸ˆì „ ê´€ë¦¬ì™€ ì‹ ë¢°ê° ìˆëŠ” ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤. ì°¨ë¶„í•˜ê²Œ í•˜ë£¨ë¥¼ ë³´ë‚´ì„¸ìš”.'),
            ('ë¶ë§ˆí¬', 'ğŸ“š', 'ì• ì •ìš´', 'í•™ì—…ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ë¶ë§ˆí¬ì…ë‹ˆë‹¤. ì±…ê°ˆí”¼ì²˜ëŸ¼ ì†Œì¤‘í•œ ìˆœê°„ì„ ê¸°ì–µí•˜ë©°, ì§€ì‹ê³¼ ì‚¬ë‘ì´ í•¨ê»˜ ìë¼ë‚©ë‹ˆë‹¤. ì˜¤ëŠ˜ ì½ì€ ì±…ì˜ í•œ êµ¬ì ˆì´ ì˜ê°ì„ ì¤„ ê²ƒì…ë‹ˆë‹¤.'),
            ('ì†ê±°ìš¸', 'ğŸª', 'ì• ì •ìš´', 'ì§ì¥ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ì†ê±°ìš¸ì…ë‹ˆë‹¤. ìì‹ ì„ ëŒì•„ë³´ëŠ” ì—¬ìœ ê°€ ë‚´ë©´ì˜ ìì‹ ê°ì„ ë†’ì—¬ì£¼ê³  ëŒ€ì¸ê´€ê³„ë¥¼ ê°œì„ í•´ì¤ë‹ˆë‹¤. ì ì‹œ ë©ˆì¶°ì„œ ìì‹ ì„ ë˜ëŒì•„ë³´ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”.'),
            ('í…€ë¸”ëŸ¬', 'ğŸ¥¤', 'í•™ì—…ìš´', 'ì§ì¥ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ í…€ë¸”ëŸ¬ì…ë‹ˆë‹¤. ê±´ê°•í•œ ìˆ˜ë¶„ ì„­ì·¨ ìŠµê´€ì€ ë§‘ì€ ì •ì‹ ê³¼ ë†’ì€ ì§‘ì¤‘ë ¥ì„ ìœ ì§€í•˜ê²Œ í•´ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ ì¶©ë¶„íˆ ë¬¼ì„ ë§ˆì‹œë©° í™œë ¥ì„ ì±„ì›Œë³´ì„¸ìš”.'),
        ]

        # ì €ë“ì (60 ë¯¸ë§Œ): ë³´í˜¸/ì•ˆì • ì•„ì´í…œ 6ê°œ
        low_score_items = [
            ('ë™ì „ í‚¤ë§', 'ğŸª™', 'ì¬ë¬¼ìš´', 'ì• ì •ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ë™ì „ í‚¤ë§ì…ë‹ˆë‹¤. ì‘ì€ ë™ì „ í•˜ë‚˜ê°€ ê¸ˆì „ìš´ì„ ì§€ì¼œì£¼ê³  ì†Œì¤‘í•œ ì¸ì—°ì„ ë³´í˜¸í•´ì¤ë‹ˆë‹¤. ë¬´ë¦¬í•˜ì§€ ë§ê³  ì•ˆì •ì ìœ¼ë¡œ í•˜ë£¨ë¥¼ ë³´ë‚´ì„¸ìš”.'),
            ('ë©”ëª¨ì¥', 'ğŸ“', 'ì¬ë¬¼ìš´', 'í•™ì—…ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ë©”ëª¨ì¥ì…ë‹ˆë‹¤. ë– ì˜¤ë¥´ëŠ” ìƒê°ì„ ë°”ë¡œ ê¸°ë¡í•˜ë©´ ì¢‹ì€ ì•„ì´ë””ì–´ì™€ ì ˆì•½ ìŠµê´€ì´ ê¸¸ëŸ¬ì§‘ë‹ˆë‹¤. ì‘ì€ ê²ƒë¶€í„° ì°¨ê·¼ì°¨ê·¼ ì •ë¦¬í•´ë³´ì„¸ìš”.'),
            ('ë¨¸í”ŒëŸ¬', 'ğŸ§¶', 'ì¬ë¬¼ìš´', 'ì§ì¥ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ë¨¸í”ŒëŸ¬ì…ë‹ˆë‹¤. ë”°ëœ»í•˜ê²Œ ê°ì‹¸ì£¼ëŠ” ë¨¸í”ŒëŸ¬ì²˜ëŸ¼ ë³´í˜¸ì˜ ê¸°ìš´ì´ ì¬ì • ì•ˆì •ê³¼ ì»¤ë¦¬ì–´ ì„±ì¥ì„ ë„ì™€ì¤ë‹ˆë‹¤. ëª¸ê³¼ ë§ˆìŒì„ ë”°ëœ»í•˜ê²Œ ìœ ì§€í•˜ì„¸ìš”.'),
            ('í—¤ì–´í•€', 'ğŸ“', 'ì• ì •ìš´', 'í•™ì—…ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ í—¤ì–´í•€ì…ë‹ˆë‹¤. ì‘ì€ í¬ì¸íŠ¸ í•˜ë‚˜ê°€ ë‹¹ì‹ ì˜ ë§¤ë ¥ì„ ë†’ì´ê³  ì§‘ì¤‘ë ¥ì„ í–¥ìƒì‹œì¼œì¤ë‹ˆë‹¤. ìì‹ ì„ ê°€ê¾¸ëŠ” ì‘ì€ ë…¸ë ¥ì´ ì¢‹ì€ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ê²ƒì…ë‹ˆë‹¤.'),
            ('ë¦½ë°¤', 'ğŸ’‹', 'ì• ì •ìš´', 'ì§ì¥ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ë¦½ë°¤ì…ë‹ˆë‹¤. ìì‹ ì„ ê°€ê¾¸ëŠ” ì‘ì€ ìŠµê´€ì´ ìì‹ ê°ì„ ë†’ì´ê³  ëŒ€ì¸ê´€ê³„ë¥¼ ê°œì„ í•©ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ ìì‹ ì—ê²Œ ì¡°ê¸ˆ ë” ì‹ ê²½ ì¨ë³´ì„¸ìš”.'),
            ('ë¯¸ë‹ˆ íŒŒìš°ì¹˜', 'ğŸ‘', 'í•™ì—…ìš´', 'ì§ì¥ìš´',
             'ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ì•„ì´í…œì€ ë¯¸ë‹ˆ íŒŒìš°ì¹˜ì…ë‹ˆë‹¤. ì •ë¦¬ëœ ì†Œì§€í’ˆì²˜ëŸ¼ ë§ˆìŒì„ ì •ëˆí•˜ë©´ í•™ìŠµê³¼ ì—…ë¬´ì— ë” ì§‘ì¤‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì£¼ë³€ì„ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•´ë³´ì„¸ìš”.'),
        ]

        # ë³„ìë¦¬ë³„ ì•„ì´í…œ ë§¤í•‘
        zodiac_items = {
            'ì–‘ìë¦¬': ('íŒ”ì°Œ', 'â­•',
                    'ì ê·¹ì ì¸ ì–‘ìë¦¬ì¸ ë‹¹ì‹ ì—ê²Œ íŒ”ì°ŒëŠ” ì—´ì •ê³¼ ìš©ê¸°ë¥¼ ë¶ˆì–´ë„£ì–´ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ íŒ”ì°Œë¥¼ ì°©ìš©í•˜ê³  ìì‹ ê°ì„ ê°€ì§€ë©´ ê¸ì •ì ì¸ ì—ë„ˆì§€ë¥¼ ë°œì‚°í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.'),
            'í™©ì†Œìë¦¬': ('í‚¤í™€ë”', 'ğŸ”—',
                     'ì•ˆì •ì„ ì¶”êµ¬í•˜ëŠ” í™©ì†Œìë¦¬ì¸ ë‹¹ì‹ ì—ê²Œ í‚¤í™€ë”ëŠ” ì¬ë¬¼ìš´ê³¼ í‰í™”ë¡œìš´ ë§ˆìŒì„ ì„ ì‚¬í•©ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ í‚¤í™€ë”ë¥¼ ê°€ê¹Œì´ ë‘ê³  ì°¨ë¶„í•˜ê²Œ ë³´ë‚´ë©´ ì¢‹ì€ ì¼ì´ ìƒê¸¸ ê²ƒì…ë‹ˆë‹¤.'),
            'ìŒë‘¥ì´ìë¦¬': ('ë¯¸ë‹ˆ ë…¸íŠ¸', 'ğŸ““',
                      'ì†Œí†µì˜ ë‹¬ì¸ ìŒë‘¥ì´ìë¦¬ì¸ ë‹¹ì‹ ì—ê²Œ ë¯¸ë‹ˆ ë…¸íŠ¸ëŠ” ì¢‹ì€ ì•„ì´ë””ì–´ì™€ ì¸ì—°ì„ ê°€ì ¸ë‹¤ì¤ë‹ˆë‹¤. ë– ì˜¤ë¥´ëŠ” ìƒê°ì„ ê¸°ë¡í•˜ë‹¤ ë³´ë©´ ì˜ˆìƒì¹˜ ëª»í•œ í–‰ìš´ì„ ë§Œë‚  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.'),
            'ê²Œìë¦¬': ('ê·€ê±¸ì´', 'âœ¨',
                    'ê°ì„±ì ì¸ ê²Œìë¦¬ì¸ ë‹¹ì‹ ì—ê²Œ ê·€ê±¸ì´ëŠ” ë§ˆìŒì˜ ì•ˆì •ê³¼ ê°€ì¡±ì˜ í™”ëª©ì„ ê°€ì ¸ë‹¤ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ ê·€ê±¸ì´ë¥¼ ì°©ìš©í•˜ë©´ ë”°ëœ»í•œ ì—ë„ˆì§€ê°€ ì£¼ë³€ì— í¼ì ¸ë‚˜ê°ˆ ê²ƒì…ë‹ˆë‹¤.'),
            'ì‚¬ììë¦¬': ('ë°˜ì§€', 'ğŸ’«',
                     'ë‹¹ë‹¹í•œ ì‚¬ììë¦¬ì¸ ë‹¹ì‹ ì—ê²Œ ë°˜ì§€ëŠ” ë¦¬ë”ì‹­ê³¼ ì¹´ë¦¬ìŠ¤ë§ˆë¥¼ ë†’ì—¬ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ ë°˜ì§€ë¥¼ ì°©ìš©í•˜ê³  ìì‹ ê° ìˆê²Œ í–‰ë™í•˜ë©´ ì£¼ë³€ì˜ ì¸ì •ì„ ë°›ì„ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.'),
            'ì²˜ë…€ìë¦¬': ('íœì¼€ì´ìŠ¤', 'âœï¸',
                     'ê¼¼ê¼¼í•œ ì²˜ë…€ìë¦¬ì¸ ë‹¹ì‹ ì—ê²Œ ì •ë¦¬ëœ íœì¼€ì´ìŠ¤ëŠ” ì§‘ì¤‘ë ¥ê³¼ ì„±ê³µì„ ê°€ì ¸ë‹¤ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ ê¹”ë”í•˜ê²Œ ì •ë¦¬ëœ ë¬¼ê±´ë“¤ ì‚¬ì´ì—ì„œ ì˜ê°ì„ ì–»ì„ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.'),
            'ì²œì¹­ìë¦¬': ('í—¤ì–´ë°´ë“œ', 'ğŸ€',
                     'ê· í˜•ì„ ì¶”êµ¬í•˜ëŠ” ì²œì¹­ìë¦¬ì¸ ë‹¹ì‹ ì—ê²Œ í—¤ì–´ë°´ë“œëŠ” í‰í™”ì™€ ì¢‹ì€ ì²«ì¸ìƒì„ ì„ ì‚¬í•©ë‹ˆë‹¤. ì˜¤ëŠ˜ í—¤ì–´ë°´ë“œë¡œ ë‹¨ì •í•˜ê²Œ ê¾¸ë¯¸ë©´ ì¢‹ì€ ì¸ì—°ì„ ë§Œë‚  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.'),
            'ì „ê°ˆìë¦¬': ('ëª©ê±¸ì´', 'ğŸ“¿',
                     'ê¹Šì€ í†µì°°ë ¥ì˜ ì „ê°ˆìë¦¬ì¸ ë‹¹ì‹ ì—ê²Œ ëª©ê±¸ì´ëŠ” ë³´í˜¸ì™€ ì§ê´€ë ¥ì„ ë†’ì—¬ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ ëª©ê±¸ì´ë¥¼ ì°©ìš©í•˜ê³  ìì‹ ê°ì„ ê°€ì§€ë©´ ê¸ì •ì ì¸ ì—ë„ˆì§€ë¥¼ ë°œì‚°í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.'),
            'ì‚¬ìˆ˜ìë¦¬': ('íŒŒìš°ì¹˜', 'ğŸ§³',
                     'ììœ ë¡œìš´ ì‚¬ìˆ˜ìë¦¬ì¸ ë‹¹ì‹ ì—ê²Œ íŒŒìš°ì¹˜ëŠ” í–‰ìš´ê³¼ ìƒˆë¡œìš´ ëª¨í—˜ì˜ ê¸°ìš´ì„ ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ íŒŒìš°ì¹˜ì— ì†Œì¤‘í•œ ë¬¼ê±´ì„ ë„£ì–´ ë‹¤ë‹ˆë©´ ì¢‹ì€ ê¸°íšŒê°€ ì°¾ì•„ì˜¬ ê²ƒì…ë‹ˆë‹¤.'),
            'ì—¼ì†Œìë¦¬': ('ì‹œê³„', 'â°',
                     'ì„±ì‹¤í•œ ì—¼ì†Œìë¦¬ì¸ ë‹¹ì‹ ì—ê²Œ ì‹œê³„ëŠ” ì¸ë‚´ì™€ ë…¸ë ¥ì— ëŒ€í•œ ì •í™•í•œ ë³´ìƒì„ ê°€ì ¸ë‹¤ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ ì‹œê°„ì„ ì˜ ê´€ë¦¬í•˜ë©´ ì›í•˜ëŠ” ëª©í‘œì— í•œ ê±¸ìŒ ë” ê°€ê¹Œì›Œì§ˆ ê²ƒì…ë‹ˆë‹¤.'),
            'ë¬¼ë³‘ìë¦¬': ('ë±ƒì§€', 'ğŸ–ï¸',
                     'ë…ì°½ì ì¸ ë¬¼ë³‘ìë¦¬ì¸ ë‹¹ì‹ ì—ê²Œ ë±ƒì§€ëŠ” ì˜ê°ê³¼ ì°½ì˜ë ¥ì„ ë¶ˆì–´ë„£ì–´ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ ë±ƒì§€ë¥¼ ë‹¬ê³  ìì‹ ë§Œì˜ ê°œì„±ì„ í‘œí˜„í•˜ë©´ íŠ¹ë³„í•œ ê¸°íšŒê°€ ì°¾ì•„ì˜¬ ê²ƒì…ë‹ˆë‹¤.'),
            'ë¬¼ê³ ê¸°ìë¦¬': ('ë¸Œë¡œì¹˜', 'ğŸŒ™',
                      'ê°ìˆ˜ì„± í’ë¶€í•œ ë¬¼ê³ ê¸°ìë¦¬ì¸ ë‹¹ì‹ ì—ê²Œ ë¸Œë¡œì¹˜ëŠ” ì§ê´€ê³¼ ë‚´ë©´ì˜ í‰í™”ë¥¼ ê°€ì ¸ë‹¤ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ ë¸Œë¡œì¹˜ë¥¼ ì°©ìš©í•˜ë©´ ë§ˆìŒì´ ì•ˆì •ë˜ê³  ì¢‹ì€ ì˜ê°ì„ ë°›ì„ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.'),
        }

        # ìš´ ì¢…ë¥˜ ì´ë¦„ ë§¤í•‘
        fortune_names = {
            'money': 'ì¬ë¬¼ìš´',
            'love': 'ì• ì •ìš´',
            'study': 'í•™ì—…ìš´',
            'work': 'ì§ì¥ìš´'
        }

        # ê¸°ë³¸ ìš´ì„¸ ì ìˆ˜ (fortune_scoresê°€ ì—†ì„ ê²½ìš°)
        if not fortune_scores:
            fortune_scores = {
                'money': 70,
                'love': 70,
                'study': 70,
                'work': 70
            }

        # 4ê°€ì§€ ìš´ ì¤‘ ê°€ì¥ ë‚®ì€ 2ê°œ ì°¾ê¸°
        sub_scores = {
            'money': fortune_scores.get('money', 70),
            'love': fortune_scores.get('love', 70),
            'study': fortune_scores.get('study', 70),
            'work': fortune_scores.get('work', 70)
        }
        sorted_scores = sorted(sub_scores.items(), key=lambda x: x[1])
        lowest_two = tuple(sorted([sorted_scores[0][0], sorted_scores[1][0]]))  # ì •ë ¬í•´ì„œ í‚¤ë¡œ ì‚¬ìš©

        # ë‚®ì€ ìš´ 2ê°œ ì¡°í•©ìœ¼ë¡œ ì•„ì´í…œ ì¸ë±ìŠ¤ ê²°ì •
        item_idx = combo_to_index.get(lowest_two, 0)

        # ì´ì  ê¸°ë°˜ ì•„ì´í…œ í’€ ì„ íƒ
        if fortune_score >= 80:
            item_pool = high_score_items
        elif fortune_score >= 60:
            item_pool = mid_score_items
        else:
            item_pool = low_score_items

        # í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ì•„ì´í…œ ì„ íƒ
        selected_item = item_pool[item_idx]

        # ì„¤ëª… ìƒì„±
        lowest_fortune_name = fortune_names[sorted_scores[0][0]]
        second_fortune_name = fortune_names[sorted_scores[1][0]]

        # ìš´ì„¸ ê¸°ë°˜ ì•„ì´í…œ ì„¤ëª… (ì•„ì´í…œ ë°ì´í„°ì˜ ì„¤ëª… ì§ì ‘ ì‚¬ìš©)
        main_description = selected_item[4]

        # ë³„ìë¦¬ ì•„ì´í…œ ì„ íƒ
        zodiac_item = zodiac_items.get(zodiac_sign, ('ë°˜ì§€', 'ğŸ’«', 'ë‹¹ì‹ ì—ê²Œ ë°˜ì§€ëŠ” ì „ë°˜ì ì¸ í–‰ìš´ì„ ê°€ì ¸ë‹¤ì¤ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ ë°˜ì§€ë¥¼ ì°©ìš©í•˜ê³  ê¸ì •ì ì¸ ë§ˆìŒìœ¼ë¡œ ë³´ë‚´ë©´ ì¢‹ì€ ì¼ì´ ìƒê¸¸ ê²ƒì…ë‹ˆë‹¤.'))

        # ë³„ìë¦¬ ì•„ì´í…œ ì„¤ëª… (2ë¬¸ì¥, ì•½ 70~80ì)
        zodiac_description = zodiac_item[2]

        return {
            'main': selected_item[0],
            'emoji': selected_item[1],
            'description': main_description,
            'weak_fortunes': f"{lowest_fortune_name}, {second_fortune_name}",
            'zodiac': zodiac_item[0],
            'zodiac_emoji': zodiac_item[1],
            'zodiac_description': zodiac_description
        }

   
    def _calculate_saju(self, birth_date: date, birth_time: Optional[datetime] = None) -> Dict:
        """ì‚¬ì£¼ ê³„ì‚° (ì •í™•í•œ ë§Œì„¸ë ¥ ê¸°ì¤€)"""
        try:
            result = self.saju_calc.calculate_saju(birth_date, birth_time)
            return {
                'year': result['saju']['year']['ganzi'],
                'month': result['saju']['month']['ganzi'],
                'day': result['saju']['day']['ganzi'],
                'hour': result['saju']['hour']['ganzi'],
                'year_stem': result['saju']['year']['gan'],
                'year_branch': result['saju']['year']['ji'],
                'year_hanja': result['year_hanja'],
                'month_hanja': result['month_hanja'],
                'day_hanja': result['day_hanja'],
                'hour_hanja': result['hour_hanja'],
                'ohaeng_scores': result['ohaeng_scores'],
                'day_ohaeng': result['day_ohaeng'],
                'strongest_ohaeng': result['strongest_ohaeng'],
                'ilju_strength': result['ilju_strength']
            }
        except Exception as e:
            print(f"[ERROR] ì‚¬ì£¼ ê³„ì‚° ì˜¤ë¥˜: {e}, ê¸°ì¡´ ë¡œì§ ì‚¬ìš©")
            # í´ë°±: ê¸°ì¡´ ê°„ë‹¨ ê³„ì‚°
            heavenly_stems = ['ê°‘', 'ì„', 'ë³‘', 'ì •', 'ë¬´', 'ê¸°', 'ê²½', 'ì‹ ', 'ì„', 'ê³„']
            earthly_branches = ['ì', 'ì¶•', 'ì¸', 'ë¬˜', 'ì§„', 'ì‚¬', 'ì˜¤', 'ë¯¸', 'ì‹ ', 'ìœ ', 'ìˆ ', 'í•´']
            
            year = birth_date.year
            year_stem = heavenly_stems[(year - 4) % 10]
            year_branch = earthly_branches[(year - 4) % 12]
            month_stem = heavenly_stems[birth_date.month % 10]
            month_branch = earthly_branches[birth_date.month % 12]
            day_stem = heavenly_stems[birth_date.day % 10]
            day_branch = earthly_branches[birth_date.day % 12]
            
            if birth_time:
                hour_stem = heavenly_stems[birth_time.hour % 10]
                hour_branch = earthly_branches[birth_time.hour % 12]
            else:
                hour_stem = heavenly_stems[0]
                hour_branch = earthly_branches[0]
            
            return {
                'year': f"{year_stem}{year_branch}",
                'month': f"{month_stem}{month_branch}",
                'day': f"{day_stem}{day_branch}",
                'hour': f"{hour_stem}{hour_branch}",
                'year_stem': year_stem,
                'year_branch': year_branch
            }
    
    def _get_zodiac_sign(self, birth_date: date) -> str:
        """ë³„ìë¦¬ ê³„ì‚°"""
        month = birth_date.month
        day = birth_date.day
        
        signs = [
            (1, 20, 'ì—¼ì†Œìë¦¬'),
            (2, 19, 'ë¬¼ë³‘ìë¦¬'),
            (3, 21, 'ë¬¼ê³ ê¸°ìë¦¬'),
            (4, 20, 'ì–‘ìë¦¬'),
            (5, 21, 'í™©ì†Œìë¦¬'),
            (6, 22, 'ìŒë‘¥ì´ìë¦¬'),
            (7, 23, 'ê²Œìë¦¬'),
            (8, 23, 'ì‚¬ììë¦¬'),
            (9, 23, 'ì²˜ë…€ìë¦¬'),
            (10, 23, 'ì²œì¹­ìë¦¬'),
            (11, 23, 'ì „ê°ˆìë¦¬'),
            (12, 22, 'ì‚¬ìˆ˜ìë¦¬'),
            (12, 31, 'ì—¼ì†Œìë¦¬'),
        ]
        
        for end_month, end_day, sign in signs:
            if month < end_month or (month == end_month and day <= end_day):
                return sign
        return 'ì—¼ì†Œìë¦¬'
    
    def _get_chinese_zodiac(self, birth_date: date) -> str:
        """ë  ê³„ì‚° (ì…ì¶˜ ê¸°ì¤€ - ì–‘ë ¥ìš©)"""
        year = birth_date.year

        # ì…ì¶˜ ë‚ ì§œ ê³„ì‚° (SajuCalculatorì˜ ë¡œì§ ì‚¬ìš©)
        ipchun = self.saju_calc._get_ipchun_date(year)

        # ì…ì¶˜ ì „ì´ë©´ ì „ë…„ë„ì˜ ë 
        if birth_date < ipchun:
            year -= 1

        zodiacs = ['ì›ìˆ­ì´', 'ë‹­', 'ê°œ', 'ë¼ì§€', 'ì¥', 'ì†Œ', 'í˜¸ë‘ì´', 'í† ë¼', 'ìš©', 'ë±€', 'ë§', 'ì–‘']
        return zodiacs[year % 12] + 'ë '

    def _get_chinese_zodiac_lunar(self, lunar_date: date) -> str:
        """ë  ê³„ì‚° (ìŒë ¥ ì„¤ë‚  ê¸°ì¤€ - ìŒë ¥ìš©)"""
        year = lunar_date.year

        # ìŒë ¥ 1ì›” 1ì¼ (ì„¤ë‚ ) ì „ì´ë©´ ì „ë…„ë„ì˜ ë 
        if lunar_date.month == 1 and lunar_date.day == 1:
            # ì„¤ë‚  ë‹¹ì¼ì€ ìƒˆí•´ì˜ ë 
            pass
        elif lunar_date.month > 1:
            # 1ì›” ì´í›„ëŠ” ë‹¹í•´ë…„ë„ì˜ ë 
            pass
        # ì‹¤ì œë¡œëŠ” ìŒë ¥ì€ í•­ìƒ ë…„ë„ë§Œìœ¼ë¡œ íŒë‹¨ (ìŒë ¥ 1/1ì´ ì„¤ë‚ )
        # ìŒë ¥ 12ì›”ìƒì€ ì „ë…„ë„ê°€ ì•„ë‹ˆë¼ í•´ë‹¹ ë…„ë„

        zodiacs = ['ì›ìˆ­ì´', 'ë‹­', 'ê°œ', 'ë¼ì§€', 'ì¥', 'ì†Œ', 'í˜¸ë‘ì´', 'í† ë¼', 'ìš©', 'ë±€', 'ë§', 'ì–‘']
        return zodiacs[year % 12] + 'ë '
    
