{% extends 'base.html' %}

{% block title %}아이템 업로드 - Fortune Life{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-6 mx-auto">
        <div class="card">
            <div class="card-body p-5">
                <h2 class="text-center mb-4">
                    <i class="fas fa-camera text-warning"></i> 아이템 업로드
                </h2>
                
                {% if not user.is_authenticated %}
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> 
                    아이템 업로드는 로그인 후 이용 가능합니다.
                    <a href="{% url 'users:login' %}" class="alert-link">로그인하기</a>
                </div>
                {% else %}
                
                <form id="uploadForm" method="POST" enctype="multipart/form-data" action="{% url 'items:upload' %}">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label class="form-label">아이템 이미지</label>
                        <div class="upload-area border rounded p-5 text-center" style="border-style: dashed !important;">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">이미지를 드래그하거나 클릭하여 업로드</p>
                            <input type="file" name="image" class="form-control" accept="image/*" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">아이템 이름</label>
                        <input type="text" name="item_name" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">대분류</label>
                        <select name="main_category" id="mainCategory" class="form-select" required>
                            <option value="">선택하세요</option>
                            <option value="clothing">의류</option>
                            <option value="cosmetics">화장품</option>
                            <option value="electronics">전자제품</option>
                            <option value="accessories">악세서리</option>
                            <option value="etc">기타</option>
                        </select>
                    </div>
                    
                    <!-- 소분류 -->
                    <div id="subCategorySection" class="mb-3" style="display: none;">
                        <label class="form-label">소분류</label>
                        <div id="subCategoryOptions"></div>
                    </div>
                    
                    <!-- 기타 - 직접 입력 -->
                    <div id="customCategorySection" class="mb-3" style="display: none;">
                        <label class="form-label">카테고리 직접 입력</label>
                        <input type="text" name="custom_category" id="customCategory" class="form-control" placeholder="예: 텀블러, 키링, 파우치 등">
                    </div>
                    
                    <!-- 하위 호환성을 위한 hidden field -->
                    <input type="hidden" name="category" value="etc">
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="is_favorite" id="favorite">
                        <label class="form-check-label" for="favorite">
                            즐겨찾기에 추가
                        </label>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-upload"></i> 업로드 및 아이템 분석
                        </button>
                    </div>
                </form>
                
                <hr class="my-4">
                
                <div class="text-center">
                    <p class="text-muted">업로드한 아이템의 색상을 분석하여<br>오늘의 행운색과 매칭도를 계산합니다</p>
                    <a href="{% url 'items:list' %}" class="btn btn-outline-primary">
                        내 아이템 보기
                    </a>
                </div>
                
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const uploadArea = document.querySelector('.upload-area');
    const fileInput = document.querySelector('input[type="file"]');
    
    // 드래그 앤 드롭 이벤트 처리
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight(e) {
        uploadArea.classList.add('bg-light');
        uploadArea.style.borderColor = '#7c3aed';
    }
    
    function unhighlight(e) {
        uploadArea.classList.remove('bg-light');
        uploadArea.style.borderColor = '#dee2e6';
    }
    
    uploadArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        fileInput.files = files;
        updateFileName(files[0]);
    }
    
    // 클릭 이벤트 처리
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });
    
    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            updateFileName(this.files[0]);
        }
    });
    
    function updateFileName(file) {
        const p = uploadArea.querySelector('p');
        p.textContent = `선택된 파일: ${file.name}`;
        p.classList.add('text-primary', 'fw-bold');
    }
    
    // 카테고리 동적 선택 로직
    const mainCategorySelect = document.getElementById('mainCategory');
    const subCategorySection = document.getElementById('subCategorySection');
    const subCategoryOptions = document.getElementById('subCategoryOptions');
    const customCategorySection = document.getElementById('customCategorySection');
    const customCategoryInput = document.getElementById('customCategory');
    
    const subCategoryMap = {
        'clothing': ['상의', '하의', '아우터', '원피스', '신발', '가방'],
        'cosmetics': ['스킨케어', '메이크업', '헤어'],
        'electronics': ['스마트폰', '태블릿', '노트북', '이어폰', '기타'],
        'accessories': ['귀걸이', '목걸이', '반지', '팔찌', '지갑'],
        'etc': []
    };
    
    mainCategorySelect.addEventListener('change', function() {
        const selectedCategory = this.value;
        
        // 초기화
        subCategorySection.style.display = 'none';
        customCategorySection.style.display = 'none';
        subCategoryOptions.innerHTML = '';
        customCategoryInput.value = '';
        customCategoryInput.removeAttribute('required');
        
        if (selectedCategory && selectedCategory !== '') {
            if (selectedCategory === 'etc') {
                // 기타 선택 시 직접 입력
                customCategorySection.style.display = 'block';
                customCategoryInput.setAttribute('required', 'required');
            } else {
                // 소분류 라디오 버튼 생성 (단일 선택)
                const subCategories = subCategoryMap[selectedCategory] || [];
                if (subCategories.length > 0) {
                    subCategorySection.style.display = 'block';
                    subCategories.forEach(sub => {
                        const radioDiv = document.createElement('div');
                        radioDiv.className = 'form-check';
                        radioDiv.innerHTML = `
                            <input class="form-check-input" type="radio" name="sub_category" value="${sub}" id="sub_${sub}">
                            <label class="form-check-label" for="sub_${sub}">
                                ${sub}
                            </label>
                        `;
                        subCategoryOptions.appendChild(radioDiv);
                    });
                }
            }
        }
    });
    
    // 로딩 화면 처리
    const form = document.getElementById('uploadForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            // 소분류 검증: etc가 아닌 경우 1개 선택 필수
            const mainCat = mainCategorySelect.value;
            if (mainCat && mainCat !== 'etc' && mainCat !== '') {
                const selectedRadio = document.querySelector('input[name="sub_category"]:checked');
                if (!selectedRadio) {
                    e.preventDefault();
                    alert('소분류를 선택해주세요.');
                    return false;
                }
            }
            
            // 로딩 화면 표시
            const loadingOverlay = document.createElement('div');
            loadingOverlay.style.position = 'fixed';
            loadingOverlay.style.top = '0';
            loadingOverlay.style.left = '0';
            loadingOverlay.style.width = '100%';
            loadingOverlay.style.height = '100%';
            loadingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            loadingOverlay.style.zIndex = '9999';
            loadingOverlay.style.display = 'flex';
            loadingOverlay.style.flexDirection = 'column';
            loadingOverlay.style.justifyContent = 'center';
            loadingOverlay.style.alignItems = 'center';
            loadingOverlay.style.color = 'white';
            
            loadingOverlay.innerHTML = `
                <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="fw-bold">업로드 및 분석 중...</h4>
                <p>잠시만 기다려주세요</p>
            `;
            
            document.body.appendChild(loadingOverlay);
        });
    }
</script>
{% endblock %}
