{% extends 'base.html' %}

{% block title %}OOTD ì¶”ì²œ - Fortune Life{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<style>
    .weather-card {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        border-radius: 25px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }
    
    .weather-card::before {
        content: '';
        position: absolute;
        top: -50px;
        right: -50px;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(124, 58, 237, 0.2) 0%, transparent 70%);
        border-radius: 50%;
        filter: blur(50px);
    }

    .current-temp {
        font-size: 72px;
        font-weight: bold;
        line-height: 1;
        background: linear-gradient(135deg, #fff 0%, #a78bfa 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .weather-desc {
        font-size: 24px;
        margin-bottom: 10px;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .temp-range {
        font-size: 18px;
        opacity: 0.7;
    }
    
    .chart-container {
        position: relative;
        height: 180px;
        width: 100%;
        margin-top: 20px;
        padding: 10px 0;
    }
    
    .chart-scroll-wrapper {
        width: 100%;
        height: 100%;
    }
    
    .rain-info-container {
        display: flex;
        justify-content: space-between;
        padding: 0 25px; /* ì°¨íŠ¸ì˜ layout paddingê³¼ ë™ì¼í•˜ê²Œ ë§ì¶¤ */
        margin-top: 5px;
        font-size: 11px;
        opacity: 0.7;
        width: 100%;
        box-sizing: border-box;
    }

    .rain-info-item {
        text-align: center;
        flex: 1;
        min-width: 0;
    }
    
    .outfit-card {
        /* border: none; removed to show glass border */
        border-radius: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        transition: transform 0.3s;
        overflow: hidden;
    }
    
    .outfit-card:hover {
        transform: translateY(-5px);
    }
    
    .color-badge {
        display: inline-block;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        margin: 0 3px;
        border: 2px solid white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Header -->
        <div class="card glass-card mb-4">
            <div class="card-body text-center py-4">
                <h1 class="display-5 fw-bold">OOTD ì¶”ì²œ</h1>
                <p class="lead text-muted">ë‚ ì”¨ì™€ í–‰ìš´ìƒ‰ ê¸°ë°˜ ì˜¤ëŠ˜ì˜ ì½”ë””</p>
                {% if lucky_colors %}
                <div class="mt-3">
                    <span class="me-2 text-white-50"><i class="fas fa-star text-warning"></i> ì˜¤ëŠ˜ì˜ í–‰ìš´ìƒ‰:</span>
                    {% for color in lucky_colors %}
                    <span class="badge fs-6 px-3 py-2 me-1 dynamic-color-badge">{{ color }}</span>
                    {% endfor %}
                </div>
                {% else %}
                <div class="mt-3">
                    <a href="{% url 'fortune:calculate' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-moon me-1"></i> ì˜¤ëŠ˜ì˜ ìš´ì„¸ë¥¼ ë¨¼ì € í™•ì¸í•˜ì„¸ìš”
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        {% if not user.is_authenticated %}
        <!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì ë©”ì‹œì§€ -->
        <div class="alert alert-warning text-center" role="alert">
            <i class="fas fa-lock"></i> <strong>ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”</strong>
            <br>
            <p class="mt-2 mb-0">OOTD ì¶”ì²œ ì„œë¹„ìŠ¤ëŠ” íšŒì› ì „ìš© ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>
            <div class="mt-3">
                <a href="{% url 'users:login' %}?next={% url 'recommendations:ootd' %}" class="btn btn-primary">
                    ë¡œê·¸ì¸í•˜ê¸°
                </a>
                <a href="{% url 'users:register' %}" class="btn btn-outline-primary">
                    íšŒì›ê°€ì…í•˜ê¸°
                </a>
            </div>
        </div>
        {% else %}

        <!-- Weather Card -->
        <div class="weather-card" id="weatherCard">
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                        <span id="cityName" class="fs-5">{{ weather.city|default:"ëŒ€ì „ ìœ ì„±êµ¬" }}</span>
                    </div>
                    <div class="current-temp mb-2" id="currentTempDisplay">
                        {{ weather.temp|default:"--" }}Â°
                    </div>
                    <div class="weather-desc" id="weatherDesc">
                        {{ weather.description|default:"ë‚ ì”¨ ì •ë³´ ì—†ìŒ" }}
                    </div>
                    <div class="temp-range">
                        <span id="tempMax">â†‘{{ weather.temp_max }}Â°</span> /
                        <span id="tempMin">â†“{{ weather.temp_min }}Â°</span>
                    </div>
                    <div class="mt-2 small opacity-75">
                        ì²´ê°ì˜¨ë„ <span id="feelsLike">{{ weather.temp }}Â°</span>
                    </div>
                </div>
                <div class="col-md-6 d-flex flex-column justify-content-center align-items-end">
                    <div style="font-size: 80px;" id="weatherIcon">
                        {% if weather.is_cold %}â„ï¸{% else %}â˜€ï¸{% endif %}
                    </div>
                    <button class="btn btn-outline-light btn-sm mt-3 rounded-pill px-3" onclick="updateWeather()">
                        <i class="fas fa-sync-alt me-1"></i> ì—…ë°ì´íŠ¸
                    </button>
                </div>
            </div>

            <!-- Hourly Forecast Chart -->
            <div style="padding-bottom: 10px;">
                <div class="chart-scroll-wrapper">
                    <canvas id="weatherChart"></canvas>
                </div>
                <!-- Rain Info aligned with chart -->
                <div class="rain-info-container" id="rainInfoContainer">
                    <!-- JSë¡œ ì±„ì›Œì§ -->
                </div>
            </div>

            <div class="row mt-3 text-center small border-top pt-3" style="border-color: rgba(255,255,255,0.1) !important;">
                <div class="col-4">
                    <i class="fas fa-tint text-primary"></i> ê°•ìˆ˜í™•ë¥  <span id="rainProb">0%</span>
                </div>
                <div class="col-4">
                    <i class="fas fa-wind text-primary"></i> í’ì† <span id="windSpeed">0m/s</span>
                </div>
                <div class="col-4">
                    <i class="fas fa-umbrella text-primary"></i> ê°•ìˆ˜ëŸ‰ <span id="rainAmount">0mm</span>
                </div>
            </div>
        </div>

        <!-- Main OOTD Recommendation -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card glass-card outfit-card h-100">
                    <div class="card-header bg-transparent border-bottom text-center" style="border-color: rgba(255,255,255,0.1);">
                        <h5 class="mb-0 text-white">ì˜¤ëŠ˜ì˜ ìƒì˜</h5>
                    </div>
                    <div class="card-body text-center">
                        <div style="font-size: 80px;">ğŸ‘•</div>
                        <h4>{{ outfit.top|default:"ë‹ˆíŠ¸" }}</h4>
                        <p class="text-muted">{{ outfit.top_desc|default:"ë”°ëœ»í•˜ê³  í¬ê·¼í•œ ëŠë‚Œ" }}</p>
                        <div class="mt-3">
                            <h6 class="text-white-50">
                                {% if lucky_colors %}<i class="fas fa-star text-warning"></i> í–‰ìš´ìƒ‰ ê¸°ë°˜{% else %}ì¶”ì²œ ìƒ‰ìƒ{% endif %}
                            </h6>
                            <span class="badge dynamic-color-badge fs-6">{{ outfit.top_color|default:"ë² ì´ì§€" }}</span>
                            {% for color in outfit.top_alt_colors %}
                            <span class="badge dynamic-color-badge fs-6">{{ color }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card glass-card outfit-card h-100">
                    <div class="card-header bg-transparent border-bottom text-center" style="border-color: rgba(255,255,255,0.1);">
                        <h5 class="mb-0 text-white">ì˜¤ëŠ˜ì˜ í•˜ì˜</h5>
                    </div>
                    <div class="card-body text-center">
                        <div style="font-size: 80px;">ğŸ‘–</div>
                        <h4>{{ outfit.bottom|default:"ì²­ë°”ì§€" }}</h4>
                        <p class="text-muted">{{ outfit.bottom_desc|default:"í¸ì•ˆí•œ ì¼ìƒ ë°”ì§€" }}</p>
                        <div class="mt-3">
                            <h6 class="text-white-50">
                                {% if lucky_colors %}<i class="fas fa-star text-warning"></i> í–‰ìš´ìƒ‰ ê¸°ë°˜{% else %}ì¶”ì²œ ìƒ‰ìƒ{% endif %}
                            </h6>
                            <span class="badge dynamic-color-badge fs-6">{{ outfit.bottom_color|default:"ë¸”ë™" }}</span>
                            {% for color in outfit.bottom_alt_colors %}
                            <span class="badge dynamic-color-badge fs-6">{{ color }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Outer Recommendation -->
        {% if outfit.outer_required %}
        <div class="card glass-card mb-4 outfit-card">
            <div class="card-header bg-transparent border-bottom text-center" style="border-color: rgba(255,255,255,0.1);">
                <h5 class="mb-0 text-white"><i class="fas fa-exclamation-circle text-warning me-2"></i>í•„ìˆ˜ ì•„ìš°í„°</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        <div style="font-size: 64px;">ğŸ§¥</div>
                    </div>
                    <div class="col-md-9">
                        <h4>{{ outfit.outer|default:"ì½”íŠ¸" }}</h4>
                        <p class="text-muted">{{ outfit.outer_desc|default:"ì˜¤ëŠ˜ê°™ì€ ë‚ ì”¨ì—” ê¼­ í•„ìš”í•©ë‹ˆë‹¤. ë°”ëŒì„ ë§‰ì•„ì£¼ëŠ” ì†Œì¬ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤." }}</p>
                        <div>
                            <span class="badge dynamic-color-badge">ë¸”ë™</span>
                            <span class="badge dynamic-color-badge">ì°¨ì½œ</span>
                            <span class="badge dynamic-color-badge">ë„¤ì´ë¹„</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Accessories Recommendation -->
        {% if outfit.accessories %}
        <div class="card glass-card mb-4 outfit-card">
            <div class="card-header bg-transparent border-bottom text-center" style="border-color: rgba(255,255,255,0.1);">
                <h5 class="mb-0 text-white"><i class="fas fa-hat-wizard text-info me-2"></i>ì¶”ì²œ ì•¡ì„¸ì„œë¦¬</h5>
            </div>
            <div class="card-body">
                <div class="row justify-content-center">
                    {% for acc in outfit.accessories %}
                    <div class="col-md-4 col-6 mb-3">
                        <div class="text-center p-3" style="background: rgba(255,255,255,0.05); border-radius: 15px;">
                            <div style="font-size: 48px;">{{ acc.emoji }}</div>
                            <h6 class="text-white mt-2 mb-1">{{ acc.name }}</h6>
                            <small class="text-muted">{{ acc.description }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    applyDynamicColors();
});

function applyDynamicColors() {
    const colorMap = {
        // ê¸°ë³¸ ìƒ‰ìƒ
        'ë¸”ë™': '#000000', 'ê²€ì€ìƒ‰': '#000000',
        'í™”ì´íŠ¸': '#FFFFFF', 'í°ìƒ‰': '#FFFFFF',
        'ê·¸ë ˆì´': '#808080', 'íšŒìƒ‰': '#808080',
        'ì°¨ì½œ': '#36454F', 'ì°¨ì½œìƒ‰': '#36454F',
        // íŒŒë€ìƒ‰ ê³„ì—´
        'ë„¤ì´ë¹„': '#000080', 'ë„¤ì´ë¹„ìƒ‰': '#000080', 'ë‚¨ìƒ‰': '#000080',
        'ë¸”ë£¨': '#0000FF', 'íŒŒë€ìƒ‰': '#0000FF',
        'ìŠ¤ì¹´ì´ë¸”ë£¨': '#87CEEB', 'í•˜ëŠ˜ìƒ‰': '#87CEEB',
        // ë¹¨ê°„ìƒ‰ ê³„ì—´
        'ë ˆë“œ': '#FF0000', 'ë¹¨ê°„ìƒ‰': '#FF0000',
        'ì§„í•œ ë¹¨ê°„ìƒ‰': '#8B0000', 'ë‹¤í¬ë ˆë“œ': '#8B0000',
        'ì™€ì¸': '#722F37', 'ë²„ê±´ë””': '#800020',
        // ë¶„í™ìƒ‰ ê³„ì—´
        'í•‘í¬': '#FFC0CB', 'ë¶„í™ìƒ‰': '#FFC0CB',
        'ë¡œì¦ˆ': '#FF007F',
        // ì£¼í™©/ë…¸ë€ìƒ‰ ê³„ì—´
        'ì˜¤ë Œì§€': '#FFA500', 'ì£¼í™©ìƒ‰': '#FFA500',
        'ì˜ë¡œìš°': '#FFD700', 'ë…¸ë€ìƒ‰': '#FFD700',
        'ë¨¸ìŠ¤íƒ€ë“œ': '#FFDB58',
        // ì´ˆë¡ìƒ‰ ê³„ì—´
        'ê·¸ë¦°': '#008000', 'ì´ˆë¡ìƒ‰': '#008000',
        'ë‹¤í¬ê·¸ë¦°': '#006400',
        'ì—°ë‘ìƒ‰': '#9ACD32', 'ë¼ì„': '#32CD32',
        'ì¹´í‚¤': '#8B8B00', 'ì¹´í‚¤ìƒ‰': '#8B8B00',
        'ì˜¬ë¦¬ë¸Œ': '#808000',
        // ë² ì´ì§€/ê°ˆìƒ‰ ê³„ì—´
        'ë² ì´ì§€': '#F5F5DC', 'ë² ì´ì§€ìƒ‰': '#F5F5DC',
        'ì˜¤íŠ¸ë°€': '#F5DEB3', 'ìƒŒë“œ': '#C2B280',
        'ë¸Œë¼ìš´': '#8B4513', 'ê°ˆìƒ‰': '#8B4513',
        'ì¹´ë©œ': '#C19A6B', 'íƒ„': '#D2B48C',
        // ë³´ë¼ìƒ‰ ê³„ì—´
        'í¼í”Œ': '#800080', 'ë³´ë¼ìƒ‰': '#800080',
        'ë¼ë²¤ë”': '#E6E6FA', 'ì—°ë³´ë¼': '#E6E6FA', 'ì—°ë³´ë¼ìƒ‰': '#E6E6FA',
        'ë°”ì´ì˜¬ë ›': '#8B00FF',
        // ê¸°íƒ€
        'ë¯¼íŠ¸': '#98FF98', 'ë¯¼íŠ¸ìƒ‰': '#98FF98',
        'ì•„ì´ë³´ë¦¬': '#FFFFF0', 'í¬ë¦¼': '#FFFDD0',
        'ì‹¤ë²„': '#C0C0C0', 'ì€ìƒ‰': '#C0C0C0',
        'ê³¨ë“œ': '#FFD700', 'ê¸ˆìƒ‰': '#FFD700',
        'ì½”ë„': '#FF7F50', 'í”¼ì¹˜': '#FFCBA4'
    };

    const badges = document.querySelectorAll('.dynamic-color-badge');
    badges.forEach(badge => {
        const text = badge.textContent.trim();
        let colorCode = colorMap[text];
        
        if (!colorCode && text.endsWith('ìƒ‰')) {
            colorCode = colorMap[text.slice(0, -1)];
        }

        if (colorCode) {
            badge.style.backgroundColor = colorCode;
            badge.style.border = '1px solid rgba(255,255,255,0.2)';
            
            // Determine text color based on background brightness
            const hex = colorCode.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            
            badge.style.color = (yiq >= 128) ? '#000000' : '#FFFFFF';
        } else {
            // Fallback
            badge.style.backgroundColor = '#4a5568';
            badge.style.color = '#ffffff';
        }
    });
}

let weatherChart = null;

// ìœ„ì¹˜ ê¸°ë°˜ ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
function updateWeather() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                // Django ë°±ì—”ë“œë¡œ ìœ„ì¹˜ ì •ë³´ ì „ì†¡
                try {
                    const response = await fetch('/recommendations/weather/location/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ lat, lon })
                    });
                    
                    const data = await response.json();
                    
                    // UI ì—…ë°ì´íŠ¸
                    if (data.success) {
                        updateWeatherUI(data);
                        showToast('ë‚ ì”¨ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }
                } catch (error) {
                    console.error('ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                    showToast('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            },
            (error) => {
                console.error('ìœ„ì¹˜ ì •ë³´ íšë“ ì‹¤íŒ¨:', error);
                
                // ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€ ì‹œ ëŒ€ì „ ìœ ì„±êµ¬ ê¸°ë³¸ê°’ ì‚¬ìš©
                fetch('/recommendations/weather/location/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ 
                        lat: 36.3621,  // ëŒ€ì „ ìœ ì„±êµ¬ ìœ„ë„
                        lon: 127.3565  // ëŒ€ì „ ìœ ì„±êµ¬ ê²½ë„
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateWeatherUI(data);
                        showToast('ëŒ€ì „ ìœ ì„±êµ¬ ë‚ ì”¨ ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.');
                    }
                })
                .catch(err => {
                    console.error('ê¸°ë³¸ ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
                    showToast('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                });
            }
        );
    } else {
        alert('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
}

function updateWeatherUI(data) {
    // ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
    document.getElementById('currentTempDisplay').textContent = `${Math.round(data.temp)}Â°`;
    document.getElementById('weatherDesc').textContent = data.description;
    document.getElementById('cityName').textContent = data.city || 'ëŒ€ì „ ìœ ì„±êµ¬';
    document.getElementById('tempMax').textContent = `â†‘${Math.round(data.temp_max)}Â°`;
    document.getElementById('tempMin').textContent = `â†“${Math.round(data.temp_min)}Â°`;
    document.getElementById('feelsLike').textContent = `${Math.round(data.temp)}Â°`; // ì²´ê°ì˜¨ë„ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í˜„ì¬ì˜¨ë„ë¡œ ëŒ€ì²´
    
    // ì¶”ê°€ ì •ë³´ ì—…ë°ì´íŠ¸
    if (data.current) {
        document.getElementById('rainProb').textContent = `${data.current.rain_probability || 0}%`;
        document.getElementById('windSpeed').textContent = `${data.current.wind_speed}m/s`;
    }
    
    // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
    const temp = data.temp;
    let icon = 'â˜€ï¸';
    if (data.description.includes('ë¹„')) icon = 'ğŸŒ§ï¸';
    else if (data.description.includes('ëˆˆ')) icon = 'â˜ƒï¸';
    else if (data.description.includes('êµ¬ë¦„') || data.description.includes('íë¦¼')) icon = 'â˜ï¸';
    else if (temp < 0) icon = 'ğŸ¥¶';
    
    document.getElementById('weatherIcon').textContent = icon;
    
    // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    if (data.hourly && data.hourly.length > 0) {
        renderChart(data.hourly);
    }
}

function renderChart(hourlyData) {
    const ctx = document.getElementById('weatherChart').getContext('2d');
    
    // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ íŒŒê´´
    if (weatherChart) {
        weatherChart.destroy();
    }
    
    const labels = hourlyData.map(item => item.time);
    const temps = hourlyData.map(item => item.temp);
    
    // ê°•ìˆ˜ ì •ë³´ ì—…ë°ì´íŠ¸ (ê·¸ë˜í”„ ì•„ë˜)
    const rainContainer = document.getElementById('rainInfoContainer');
    rainContainer.innerHTML = '';
    
    hourlyData.forEach(item => {
        const div = document.createElement('div');
        div.className = 'rain-info-item';
        // ê°•ìˆ˜í™•ë¥ ì´ 0ì´ë©´ í‘œì‹œ ì•ˆí•˜ê±°ë‚˜ íë¦¬ê²Œ, ìˆìœ¼ë©´ íŒŒë€ìƒ‰ ë“±
        const rainProb = item.rain_probability;
        const rainAmt = item.rain_amount;
        
        let html = '';
        // ê°•ìˆ˜í™•ë¥  í‘œì‹œ (0%ë„ í‘œì‹œ)
        html += `<div style="color: white; margin-bottom: 2px;">${rainProb}%</div>`;
        
        if (rainAmt > 0) {
            html += `<div style="color: #81d4fa;">${rainAmt}mm</div>`;
        }
        
        div.innerHTML = html;
        rainContainer.appendChild(div);
    });
    
    // Chart.js í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
    Chart.register(ChartDataLabels);

    weatherChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'ê¸°ì˜¨ (Â°C)',
                data: temps,
                borderColor: 'rgba(255, 255, 255, 0.9)',
                backgroundColor: 'rgba(255, 255, 255, 0.1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(255, 255, 255, 1)',
                pointRadius: 4,
                tension: 0.4,
                fill: false, // ì±„ìš°ê¸° ë” (ê¹”ë”í•˜ê²Œ ë¼ì¸ë§Œ)
                datalabels: {
                    align: 'top',
                    anchor: 'end',
                    color: 'white',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    formatter: function(value) {
                        return Math.round(value) + 'Â°';
                    }
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false // íˆ´íŒ ë” (ë¼ë²¨ì´ ìˆìœ¼ë¯€ë¡œ)
                },
                datalabels: {
                    display: true
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false,
                        drawBorder: false
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.8)',
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    display: false, // Yì¶• ì™„ì „ ìˆ¨ê¹€
                    min: Math.min(...temps) - 5, // ë¼ë²¨ ê³µê°„ í™•ë³´ë¥¼ ìœ„í•´ ì—¬ìœ  ë‘ 
                    max: Math.max(...temps) + 5
                }
            },
            layout: {
                padding: {
                    left: 25,
                    right: 25,
                    top: 20, // ìƒë‹¨ ë¼ë²¨ ê³µê°„
                    bottom: 10
                }
            }
        }
    });
    
    // ê°•ìˆ˜ ì •ë³´ ì»¨í…Œì´ë„ˆ ë„ˆë¹„ ì¡°ì • (ê·¸ë˜í”„ í¬ì¸íŠ¸ì™€ ì •ë ¬ ë§ì¶”ê¸° ìœ„í•´ flex-grow ì‚¬ìš© ë˜ëŠ” width ì¡°ì •)
    // Chart.jsëŠ” ìº”ë²„ìŠ¤ ë‚´ì—ì„œ ê·¸ë ¤ì§€ë¯€ë¡œ ì •í™•í•œ HTML ìš”ì†Œì™€ 1:1 ë§¤ì¹­ì´ ê¹Œë‹¤ë¡œìš¸ ìˆ˜ ìˆìŒ.
    // flex space-betweenìœ¼ë¡œ ëŒ€ëµ ë§ì¶¤.
}

// í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 end-0 p-3';
    toast.style.zIndex = '11';
    toast.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ìœ„ì¹˜ ê¸°ë°˜ ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', function() {
    // 5ì´ˆ í›„ ìë™ ì—…ë°ì´íŠ¸ (ì‚¬ìš©ìê°€ ê±°ë¶€í•  ìˆ˜ ìˆë„ë¡)
    setTimeout(() => {
        if (confirm('í˜„ì¬ ìœ„ì¹˜ì˜ ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            updateWeather();
        }
    }, 1000);
});
</script>
{% endblock %}