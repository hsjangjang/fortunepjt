{% extends 'base.html' %}

{% block title %}ì•„ì´í…œ í–‰ìš´ë„ ì¸¡ì • - Fortune Life{% endblock %}

{% block extra_css %}
<style>
    .upload-area {
        border: 3px dashed rgba(124, 58, 237, 0.5);
        border-radius: 20px;
        padding: 60px 20px;
        text-align: center;
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(10px);
        cursor: pointer;
        transition: all 0.3s;
    }

    .upload-area:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: #7c3aed;
        box-shadow: 0 0 20px rgba(124, 58, 237, 0.2);
    }

    .upload-area.dragover {
        background: rgba(124, 58, 237, 0.1);
        border-color: #7c3aed;
        transform: scale(1.02);
    }

    .result-card {
        display: none;
        margin-top: 30px;
    }

    .luck-score-circle {
        width: 200px;
        height: 200px;
        position: relative;
        margin: 0 auto;
    }

    .luck-score-circle svg {
        transform: rotate(-90deg);
    }

    .luck-score-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .color-match {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 30px;
        margin: 30px 0;
    }

    .color-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .match-arrow {
        font-size: 2rem;
        color: #9ca3af;
    }

    .item-preview {
        max-width: 300px;
        max-height: 300px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .reference-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .reference-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        background: rgba(255, 255, 255, 0.08);
        padding: 0.75rem;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .reference-item .label {
        color: rgba(255,255,255,0.6);
        font-size: 0.8rem;
        margin-bottom: 0.3rem;
    }

    .reference-item .value {
        color: #fff;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .item-select-card {
        transition: all 0.3s;
    }

    .item-select-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="content-wrapper">
        {# í˜ì´ì§€ í—¤ë” #}
        {% include 'includes/page_header.html' with title="ì•„ì´í…œ í–‰ìš´ë„ ì¸¡ì •" subtitle="ê°€ì§€ê³  ìˆëŠ” ì•„ì´í…œì„ ì´¬ì˜í•˜ê±°ë‚˜ ì—…ë¡œë“œí•˜ì—¬ ì˜¤ëŠ˜ì˜ í–‰ìš´ ì•„ì´í…œê³¼ ì–¼ë§ˆë‚˜ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”!" icon="fas fa-search" %}

        <div class="card-base card-lg">

                <!-- Upload Area -->
                <div id="upload-area" class="upload-area">
                    <i class="fas fa-camera fa-4x text-primary mb-3"></i>
                    <h4 class="text-white">ì•„ì´í…œ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</h4>
                    <p class="text-white opacity-50">
                        í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­<br>
                        JPG, PNG íŒŒì¼ (ìµœëŒ€ 10MB)
                    </p>
                    <input type="file" id="item-upload" accept="image/*" style="display: none;">
                </div>

                <!-- Select from My Items Button -->
                {% if user.is_authenticated and user_items %}
                <div class="text-center mt-4">
                    <button class="btn btn-outline-light rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#itemSelectModal">
                        <i class="fas fa-folder-open me-2"></i> ë‚´ ì•„ì´í…œì—ì„œ ì„ íƒí•˜ê¸°
                    </button>
                </div>
                {% endif %}

                <!-- Analysis Result -->
                <div id="result-card" class="result-card glass-card mt-4 border-0" style="background: rgba(255, 255, 255, 0.05);">
                    <div class="card-body">
                        <h4 class="text-center text-white mb-4">ë¶„ì„ ê²°ê³¼</h4>

                        <!-- Item Preview -->
                        <div class="text-center mb-4">
                            <img id="item-preview" src="" alt="ì—…ë¡œë“œëœ ì•„ì´í…œ" class="item-preview" style="border: 1px solid rgba(255,255,255,0.2);">
                        </div>

                        <!-- Detected Item Info -->
                        <div class="row mb-4">
                            <div class="col-md-6 text-center text-md-start">
                                <h5 class="text-primary-light">ì¸ì‹ëœ ì•„ì´í…œ</h5>
                                <p class="fs-4 text-white fw-bold" id="detected-item">ë¶„ì„ì¤‘...</p>
                            </div>
                            <div class="col-md-6 text-center text-md-start">
                                <h5 class="text-primary-light">ê°ì§€ëœ ìƒ‰ìƒ</h5>
                                <div class="d-flex gap-2 justify-content-center justify-content-md-start" id="detected-colors">
                                    <!-- ìƒ‰ìƒì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                </div>
                            </div>
                        </div>

                        <!-- Luck Score -->
                        <div class="luck-score-circle">
                            <svg width="200" height="200">
                                <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="20"></circle>
                                <circle cx="100" cy="100" r="90" fill="none" stroke="url(#luckGradient)"
                                    stroke-width="20" stroke-dasharray="565" stroke-dashoffset="565" id="luck-progress"
                                    style="transition: stroke-dashoffset 1.5s ease-out;"></circle>
                                <defs>
                                    <linearGradient id="luckGradient">
                                        <stop offset="0%" stop-color="#10b981"></stop>
                                        <stop offset="100%" stop-color="#3b82f6"></stop>
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="luck-score-text">
                                <h1 id="luck-score" class="text-white fw-bold mb-0">0</h1>
                                <p class="text-white opacity-75 mb-0">í–‰ìš´ ì§€ìˆ˜</p>
                            </div>
                        </div>

                        <!-- Color Match Visualization -->
                        <div class="color-match">
                            <div class="text-center">
                                <p class="text-white opacity-75 mb-2">ì•„ì´í…œ ìƒ‰ìƒ</p>
                                <div class="color-circle" id="item-color" style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2);"></div>
                            </div>
                            <div class="match-arrow text-white opacity-50">
                                <i class="fas fa-arrows-alt-h"></i>
                            </div>
                            <div class="text-center">
                                <p class="text-white opacity-75 mb-2">ì˜¤ëŠ˜ì˜ í–‰ìš´ìƒ‰</p>
                                <div class="color-circle" id="lucky-color"
                                    style="background: {% if lucky_colors_with_hex %}{{ lucky_colors_with_hex.0.hex }}{% else %}#667eea{% endif %}; border: 2px solid rgba(255,255,255,0.2);"></div>
                            </div>
                        </div>

                        <!-- Match Details -->
                        <div class="alert mt-4 text-center" style="background: rgba(124, 58, 237, 0.2); border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 15px;">
                            <h5 id="match-title" class="text-white fw-bold mb-2">ë¶„ì„ ì¤‘...</h5>
                            <p id="match-description" class="text-white opacity-90 mb-0">ì•„ì´í…œì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                        </div>

                        <!-- Today's Lucky Item Reference -->
                        <div class="glass-card mt-4 p-4" style="background: rgba(0,0,0,0.2);">
                            <h6 class="text-white mb-3"><i class="fas fa-star text-warning me-2"></i> ì˜¤ëŠ˜ì˜ í–‰ìš´ ì•„ì´í…œ</h6>
                            <div class="reference-grid">
                                <div class="reference-item">
                                    <span class="label">ë©”ì¸</span>
                                    <span class="value">{{ lucky_item.main|default:"ë¯¸ë‹ˆ í‚¤ë§" }}</span>
                                </div>
                                <div class="reference-item">
                                    <span class="label">ë³„ìë¦¬</span>
                                    <span class="value">{{ lucky_item.zodiac|default:"ì‹¤ë²„ í‚¤ë§" }}</span>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-top border-secondary border-opacity-25">
                                <span class="text-white opacity-75 me-2">í–‰ìš´ìƒ‰:</span>
                                {% for color in lucky_colors_with_hex %}
                                <span class="badge rounded-pill me-1 border border-light border-opacity-25"
                                      style="background-color: {{ color.hex }}; color: {% if color.is_light %}#000{% else %}#fff{% endif %}; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                    {{ color.name }}
                                </span>
                                {% empty %}
                                <span class="badge bg-secondary">ì •ë³´ ì—†ìŒ</span>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="action-buttons mt-4">
                            <button class="btn btn-primary btn-lg rounded-pill px-5" onclick="resetUpload()">
                                <i class="fas fa-redo me-2"></i> ë‹¤ë¥¸ ì•„ì´í…œ ì¸¡ì •í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>
        </div>
    </div>
</div>

<!-- Item Selection Modal -->
{% if user.is_authenticated and user_items %}
<div class="modal fade" id="itemSelectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-card border-0" style="background: #1e293b;">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white"><i class="fas fa-folder-open me-2"></i> ë‚´ ì•„ì´í…œ ì„ íƒ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    {% for item in user_items %}
                    <div class="col-md-4">
                        <div class="card h-100 item-select-card border-0"
                             style="cursor: pointer; background: rgba(255,255,255,0.05);"
                             data-item-name="{{ item.item_name }}"
                             data-item-image="{{ item.image.url }}"
                             data-item-colors="{{ item.colors_json|default:'[]' }}"
                             data-ai-analysis='{{ item.ai_analysis_json|default:"{}" }}'
                             onclick="selectExistingItem(this)">
                            <img src="{{ item.image.url }}" class="card-img-top" alt="{{ item.item_name }}"
                                 style="height: 150px; object-fit: cover; opacity: 0.8;">
                            <div class="card-body text-center p-2">
                                <h6 class="mb-1 text-white">{{ item.item_name }}</h6>
                                <small class="text-white opacity-50">{{ item.created_at|date:"Y.m.d" }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Lucky Colors Data -->
<script id="lucky-colors-data" type="application/json">{{ lucky_colors|safe }}</script>
<script id="lucky-items-data" type="application/json">{{ lucky_item_json|safe }}</script>
{% endblock %}

{% block extra_js %}
<script>
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('item-upload');
    const resultCard = document.getElementById('result-card');

    // í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
    uploadArea.addEventListener('click', function(e) {
        if (e.target !== fileInput) {
            fileInput.click();
        }
    });

    // íŒŒì¼ ì„ íƒ ì‹œ ì²˜ë¦¬
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    // íŒŒì¼ ì²˜ë¦¬
    function handleFile(file) {
        // ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸
        if (!file.type.startsWith('image/')) {
            alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }

        // íŒŒì¼ í¬ê¸° í™•ì¸ (10MB)
        if (file.size > 10 * 1024 * 1024) {
            alert('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('item-preview').src = e.target.result;
            uploadArea.style.display = 'none';
            resultCard.style.display = 'block';

            // ë¶„ì„ ì‹œì‘
            analyzeItem(file);
        };
        reader.readAsDataURL(file);
    }

    // ì•„ì´í…œ ë¶„ì„
    async function analyzeItem(file) {
        // ë¶„ì„ ì‹œì‘ ì‹œ ì´ì „ ê²°ê³¼ ì´ˆê¸°í™”
        document.getElementById('detected-item').textContent = 'ë¶„ì„ ì¤‘...';
        document.getElementById('detected-colors').innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"></div>';
        document.getElementById('item-color').style.background = 'rgba(255,255,255,0.1)';
        document.getElementById('luck-score').textContent = '0';
        document.getElementById('luck-progress').style.strokeDashoffset = '565';
        document.getElementById('match-title').textContent = 'ë¶„ì„ ì¤‘...';
        document.getElementById('match-description').textContent = 'ì•„ì´í…œì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.';

        const formData = new FormData();
        formData.append('image', file);
        formData.append('item_name', 'ì„ì‹œ_' + Date.now());
        formData.append('category', 'etc');
        formData.append('is_temporary', 'true');

        try {
            const response = await fetch('/items/analyze/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();
            console.log('[DEBUG] ë¶„ì„ ê²°ê³¼:', data);

            if (data.success) {
                const analysis = data.analysis || {};
                const colors = analysis.colors || [];

                // ì•„ì´í…œ ì´ë¦„ í‘œì‹œ
                document.getElementById('detected-item').textContent = data.suggested_name || data.item_name || 'ì•Œ ìˆ˜ ì—†ìŒ';

                // ìƒ‰ìƒ í‘œì‹œ
                if (colors.length > 0) {
                    const colorsHtml = colors.slice(0, 3).map(c =>
                        `<div style="width: 40px; height: 40px; border-radius: 50%; background: ${c.hex}; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>`
                    ).join('');
                    document.getElementById('detected-colors').innerHTML = colorsHtml;
                    document.getElementById('item-color').style.background = colors[0].hex;

                    // í–‰ìš´ ì ìˆ˜ ê³„ì‚° ë° í‘œì‹œ
                    const result = calculateLuckScore(data.suggested_name || data.item_name, colors);
                    animateLuckScore(result.score);
                    updateMatchDescription(result.score, data.suggested_name || data.item_name, result.matchedColor);
                } else {
                    document.getElementById('detected-colors').innerHTML = '<span class="text-white opacity-50">ìƒ‰ìƒ ì •ë³´ ì—†ìŒ</span>';
                    animateLuckScore(50);
                    updateMatchDescription(50, data.suggested_name || 'ì•„ì´í…œ', null);
                }
            } else {
                alert(data.message || 'ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                resetUpload();
            }
        } catch (error) {
            console.error('[ERROR] ë¶„ì„ ì‹¤íŒ¨:', error);
            alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            resetUpload();
        }
    }

    // ê¸°ì¡´ ì•„ì´í…œ ì„ íƒ
    function selectExistingItem(element) {
        const itemName = element.dataset.itemName;
        const imageUrl = element.dataset.itemImage;
        const colorsJson = element.dataset.itemColors;
        const aiAnalysisJson = element.dataset.aiAnalysis;

        // ëª¨ë‹¬ ë‹«ê¸°
        const modal = bootstrap.Modal.getInstance(document.getElementById('itemSelectModal'));
        if (modal) modal.hide();

        // AI ë¶„ì„ ê²°ê³¼ì—ì„œ ì•„ì´í…œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ë” ì •í™•í•œ ì¸ì‹)
        let displayName = itemName;
        try {
            const aiAnalysis = JSON.parse(aiAnalysisJson || '{}');
            if (aiAnalysis.item_name) {
                displayName = aiAnalysis.item_name;
            }
        } catch (e) {}

        // ê²°ê³¼ í‘œì‹œ
        document.getElementById('item-preview').src = imageUrl;
        resultCard.style.display = 'block';
        uploadArea.style.display = 'none';
        document.getElementById('detected-item').textContent = displayName;

        try {
            const colors = JSON.parse(colorsJson);

            if (colors && colors.length > 0) {
                const colorsHtml = colors.slice(0, 3).map(c =>
                    `<div style="width: 40px; height: 40px; border-radius: 50%; background: ${c.hex}; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>`
                ).join('');
                document.getElementById('detected-colors').innerHTML = colorsHtml;
                document.getElementById('item-color').style.background = colors[0].hex;

                const result = calculateLuckScore(displayName, colors);
                animateLuckScore(result.score);
                updateMatchDescription(result.score, displayName, result.matchedColor);
            } else {
                document.getElementById('detected-colors').innerHTML = '<span class="text-white opacity-50">ìƒ‰ìƒ ì •ë³´ ì—†ìŒ</span>';
                animateLuckScore(50);
                updateMatchDescription(50, displayName, null);
            }
        } catch (error) {
            console.error('[ERROR] ìƒ‰ìƒ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', error);
            alert('ì•„ì´í…œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            resetUpload();
        }
    }

    // í–‰ìš´ ì ìˆ˜ ê³„ì‚° (ì•„ì´í…œ ìœ ì‚¬ë„ ê¸°ë°˜ + ìƒ‰ìƒ ì¶”ê°€ì )
    function calculateLuckScore(itemName, colors) {
        let baseScore = 30;  // ê¸°ë³¸ ì ìˆ˜ (ë‚®ì¶¤)
        let itemScore = 0;   // ì•„ì´í…œ ìœ ì‚¬ë„ ì ìˆ˜
        let colorScore = 0;  // ìƒ‰ìƒ ë§¤ì¹­ ì ìˆ˜
        let matchedColor = null;  // ë§¤ì¹­ëœ í–‰ìš´ìƒ‰

        try {
            // í–‰ìš´ ì•„ì´í…œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const luckyItemsData = JSON.parse(document.getElementById('lucky-items-data').textContent || '{}');
            const luckyItems = [
                { name: luckyItemsData.main, weight: 40 },        // ë©”ì¸ ì•„ì´í…œ: ìµœëŒ€ 40ì 
                { name: luckyItemsData.zodiac, weight: 25 },      // ë³„ìë¦¬ ì•„ì´í…œ: ìµœëŒ€ 25ì 
                { name: luckyItemsData.today_special, weight: 20 } // íŠ¹ë³„ ì•„ì´í…œ: ìµœëŒ€ 20ì 
            ].filter(i => i.name);

            const itemLower = (itemName || '').toLowerCase().trim();

            // ì•„ì´í…œ ìœ ì‚¬ë„ ê³„ì‚° (ë¶€ë¶„ ì¼ì¹˜, ìœ ì‚¬ ë‹¨ì–´ ë“±)
            for (const luckyItem of luckyItems) {
                const luckyLower = (luckyItem.name || '').toLowerCase().trim();

                // ì™„ì „ ì¼ì¹˜
                if (itemLower === luckyLower) {
                    itemScore = Math.max(itemScore, luckyItem.weight);
                    continue;
                }

                // í¬í•¨ ê´€ê³„ (í•œìª½ì´ ë‹¤ë¥¸ìª½ì„ í¬í•¨)
                if (itemLower.includes(luckyLower) || luckyLower.includes(itemLower)) {
                    itemScore = Math.max(itemScore, Math.floor(luckyItem.weight * 0.8));
                    continue;
                }

                // ìœ ì‚¬ ì¹´í…Œê³ ë¦¬ ë§¤ì¹­ (í‚¤ì›Œë“œ ê¸°ë°˜)
                const similarity = calculateItemSimilarity(itemLower, luckyLower);
                if (similarity > 0) {
                    itemScore = Math.max(itemScore, Math.floor(luckyItem.weight * similarity));
                }
            }

            // ìƒ‰ìƒ ë§¤ì¹­ (ìµœëŒ€ 15ì  ì¶”ê°€)
            const luckyColors = JSON.parse(document.getElementById('lucky-colors-data').textContent || '[]');
            if (colors && colors.length > 0 && luckyColors.length > 0) {
                const itemColorName = colors[0].korean_name;

                // 1. ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš°
                if (luckyColors.includes(itemColorName)) {
                    colorScore = 15;
                    matchedColor = itemColorName;
                } else {
                    // 2. ìœ ì‚¬ ìƒ‰ìƒ ë§¤ì¹­ - ê°€ì¥ ê°€ê¹Œìš´ í–‰ìš´ìƒ‰ ì°¾ê¸°
                    const closestLuckyColor = findClosestLuckyColor(itemColorName, luckyColors);
                    if (closestLuckyColor) {
                        colorScore = 10;  // ìœ ì‚¬ ìƒ‰ìƒì€ 10ì 
                        matchedColor = closestLuckyColor;
                    }
                }
            }
        } catch (error) {
            console.error('[ERROR] ì ìˆ˜ ê³„ì‚° ì˜¤ë¥˜:', error);
        }

        return { score: Math.min(100, baseScore + itemScore + colorScore), matchedColor: matchedColor };
    }

    // ìƒ‰ìƒ ì´ë¦„ -> RGB ë§¤í•‘
    const colorToRGB = {
        'ë¹¨ê°„ìƒ‰': { r: 255, g: 0, b: 0 },
        'ì£¼í™©ìƒ‰': { r: 255, g: 165, b: 0 },
        'ë…¸ë€ìƒ‰': { r: 255, g: 255, b: 0 },
        'ì´ˆë¡ìƒ‰': { r: 0, g: 128, b: 0 },
        'ì—°ë‘ìƒ‰': { r: 144, g: 238, b: 144 },
        'í•˜ëŠ˜ìƒ‰': { r: 135, g: 206, b: 235 },
        'íŒŒë€ìƒ‰': { r: 0, g: 0, b: 255 },
        'ë‚¨ìƒ‰': { r: 0, g: 0, b: 128 },
        'ë³´ë¼ìƒ‰': { r: 128, g: 0, b: 128 },
        'ìì£¼ìƒ‰': { r: 128, g: 0, b: 128 },
        'ë¶„í™ìƒ‰': { r: 255, g: 192, b: 203 },
        'ê°ˆìƒ‰': { r: 139, g: 69, b: 19 },
        'ë² ì´ì§€ìƒ‰': { r: 245, g: 222, b: 179 },
        'ê²€ì€ìƒ‰': { r: 0, g: 0, b: 0 },
        'í°ìƒ‰': { r: 255, g: 255, b: 255 },
        'íšŒìƒ‰': { r: 128, g: 128, b: 128 },
        'ê¸ˆìƒ‰': { r: 255, g: 215, b: 0 }
    };

    // ìƒ‰ìƒ ì´ë¦„ -> HEX ë§¤í•‘
    const colorToHex = {
        'ë¹¨ê°„ìƒ‰': '#FF0000', 'ì£¼í™©ìƒ‰': '#FFA500', 'ë…¸ë€ìƒ‰': '#FFFF00',
        'ì´ˆë¡ìƒ‰': '#008000', 'ì—°ë‘ìƒ‰': '#90EE90', 'í•˜ëŠ˜ìƒ‰': '#87CEEB',
        'íŒŒë€ìƒ‰': '#0000FF', 'ë‚¨ìƒ‰': '#000080', 'ë³´ë¼ìƒ‰': '#800080',
        'ìì£¼ìƒ‰': '#800080', 'ë¶„í™ìƒ‰': '#FFC0CB', 'ê°ˆìƒ‰': '#8B4513',
        'ë² ì´ì§€ìƒ‰': '#F5DEB3', 'ê²€ì€ìƒ‰': '#000000', 'í°ìƒ‰': '#FFFFFF',
        'íšŒìƒ‰': '#808080', 'ê¸ˆìƒ‰': '#FFD700'
    };

    // ê°€ì¥ ê°€ê¹Œìš´ í–‰ìš´ìƒ‰ ì°¾ê¸° (RGB ì°¨ì´ ê¸°ë°˜)
    function findClosestLuckyColor(itemColor, luckyColors) {
        const itemRGB = colorToRGB[itemColor];
        if (!itemRGB || luckyColors.length === 0) {
            return luckyColors[0] || null;
        }

        let closestColor = luckyColors[0];
        let minDiff = Infinity;

        for (const luckyColor of luckyColors) {
            const luckyRGB = colorToRGB[luckyColor];
            if (!luckyRGB) continue;

            // RGB ê°’ì˜ ì°¨ì´ í•©ê³„ ê³„ì‚°
            const diff = Math.abs(itemRGB.r - luckyRGB.r) +
                         Math.abs(itemRGB.g - luckyRGB.g) +
                         Math.abs(itemRGB.b - luckyRGB.b);

            if (diff < minDiff) {
                minDiff = diff;
                closestColor = luckyColor;
            }
        }

        return closestColor;
    }

    // ì•„ì´í…œ ìœ ì‚¬ë„ ê³„ì‚° (ì¹´í…Œê³ ë¦¬/í‚¤ì›Œë“œ ê¸°ë°˜)
    function calculateItemSimilarity(item1, item2) {
        const categoryKeywords = {
            'ì•¡ì„¸ì„œë¦¬': ['ëª©ê±¸ì´', 'ë°˜ì§€', 'íŒ”ì°Œ', 'ê·€ê±¸ì´', 'íœë˜íŠ¸', 'ë¸Œë ˆì´ìŠ¬ë¦¿', 'í‚¤ë§', 'ì—´ì‡ ê³ ë¦¬'],
            'ê°€ë°©ë¥˜': ['ê°€ë°©', 'ë°±', 'íŒŒìš°ì¹˜', 'ì§€ê°‘', 'ìºë¦¬ì–´', 'í† íŠ¸', 'í´ëŸ¬ì¹˜'],
            'ì „ìê¸°ê¸°': ['ì´ì–´í°', 'í—¤ë“œí°', 'ì‹œê³„', 'ì¹´ë©”ë¼', 'íƒœë¸”ë¦¿', 'í°'],
            'íŒ¨ì…˜ì†Œí’ˆ': ['ìŠ¤ì¹´í”„', 'ëª¨ì', 'ì„ ê¸€ë¼ìŠ¤', 'ì•ˆê²½', 'ë²¨íŠ¸', 'ì¥ê°‘'],
            'í•„ê¸°êµ¬': ['íœ', 'ë§Œë…„í•„', 'ë‹¤ì´ì–´ë¦¬', 'ë…¸íŠ¸'],
            'ìŒë£Œìš©í’ˆ': ['í…€ë¸”ëŸ¬', 'ë¨¸ê·¸ì»µ', 'ì»µ', 'ë³´í‹€']
        };

        let maxSimilarity = 0;

        for (const [category, keywords] of Object.entries(categoryKeywords)) {
            const item1Match = keywords.some(kw => item1.includes(kw));
            const item2Match = keywords.some(kw => item2.includes(kw));

            if (item1Match && item2Match) {
                // ê°™ì€ ì¹´í…Œê³ ë¦¬ë©´ 0.5 ìœ ì‚¬ë„
                maxSimilarity = Math.max(maxSimilarity, 0.5);
            }
        }

        // ê³µí†µ ë‹¨ì–´ ì²´í¬ (2ê¸€ì ì´ìƒ)
        const words1 = item1.split(/[\s,_-]+/);
        const words2 = item2.split(/[\s,_-]+/);

        for (const w1 of words1) {
            for (const w2 of words2) {
                if (w1.length >= 2 && w2.length >= 2) {
                    if (w1.includes(w2) || w2.includes(w1)) {
                        maxSimilarity = Math.max(maxSimilarity, 0.6);
                    }
                }
            }
        }

        return maxSimilarity;
    }

    // ì ìˆ˜ ì• ë‹ˆë©”ì´ì…˜
    function animateLuckScore(targetScore) {
        const scoreElement = document.getElementById('luck-score');
        const progressElement = document.getElementById('luck-progress');
        const circumference = 2 * Math.PI * 90;

        let current = 0;
        const interval = setInterval(() => {
            if (current < targetScore) {
                current += 2;
                if (current > targetScore) current = targetScore;
                scoreElement.textContent = current;

                const offset = circumference - (current / 100 * circumference);
                progressElement.style.strokeDashoffset = offset;
            } else {
                clearInterval(interval);
            }
        }, 20);
    }

    // ë§¤ì¹˜ ì„¤ëª… ì—…ë°ì´íŠ¸ (ì ìˆ˜ êµ¬ê°„ë³„ ì„¸ë¶„í™”)
    function updateMatchDescription(score, item, matchedColor) {
        const titleElement = document.getElementById('match-title');
        const descElement = document.getElementById('match-description');
        const luckyColorElement = document.getElementById('lucky-color');

        // í–‰ìš´ ì•„ì´í…œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        let luckyItemsData = {};
        try {
            luckyItemsData = JSON.parse(document.getElementById('lucky-items-data').textContent || '{}');
        } catch (e) {}

        // ë§¤ì¹­ëœ í–‰ìš´ìƒ‰ìœ¼ë¡œ "ì˜¤ëŠ˜ì˜ í–‰ìš´ìƒ‰" ì› ì—…ë°ì´íŠ¸
        if (matchedColor && colorToHex[matchedColor]) {
            luckyColorElement.style.background = colorToHex[matchedColor];
        }

        // matchedColorëŠ” ì‹¤ì œë¡œ í–‰ìš´ìƒ‰ê³¼ ë§¤ì¹­ëœ ê²½ìš°ì—ë§Œ ê°’ì´ ìˆìŒ
        const colorText = matchedColor ? matchedColor + ' ìƒ‰ìƒì´ ' : '';

        if (score >= 85) {
            titleElement.textContent = 'ğŸ‰ ì™„ë²½í•œ ë§¤ì¹˜!';
            descElement.textContent = `${item}ì´(ê°€) ì˜¤ëŠ˜ì˜ í–‰ìš´ ì•„ì´í…œê³¼ ì™„ë²½í•˜ê²Œ ì¼ì¹˜í•©ë‹ˆë‹¤! ìµœê³ ì˜ í–‰ìš´ì´ í•¨ê»˜í•  ê²ƒì…ë‹ˆë‹¤.`;
        } else if (score >= 70) {
            titleElement.textContent = 'âœ¨ í›Œë¥­í•œ ë§¤ì¹˜!';
            descElement.textContent = `${item}ì´(ê°€) ì˜¤ëŠ˜ì˜ í–‰ìš´ê³¼ ì˜ ì–´ìš¸ë¦½ë‹ˆë‹¤. ${colorText}í–‰ìš´ì„ ë”í•´ì¤„ ê²ƒì…ë‹ˆë‹¤.`;
        } else if (score >= 55) {
            titleElement.textContent = 'ğŸ‘ ì¢‹ì€ ë§¤ì¹˜';
            descElement.textContent = `${item}ì´(ê°€) ì˜¤ëŠ˜ì˜ ìš´ì„¸ì™€ ì–´ëŠ ì •ë„ ì–´ìš¸ë¦½ë‹ˆë‹¤. ê¸ì •ì ì¸ ì—ë„ˆì§€ë¥¼ ëŠë‚„ ìˆ˜ ìˆì„ ê±°ì˜ˆìš”.`;
        } else if (score >= 45) {
            titleElement.textContent = 'ğŸ˜ ë¬´ë‚œí•œ ì„ íƒ';
            descElement.textContent = `${item}ì€(ëŠ”) í‰ë²”í•œ ì„ íƒì…ë‹ˆë‹¤. í–‰ìš´ ì•„ì´í…œì¸ '${luckyItemsData.main || 'ì¶”ì²œ ì•„ì´í…œ'}'ì„ í™œìš©í•´ë³´ì„¸ìš”.`;
        } else if (score >= 35) {
            titleElement.textContent = 'ğŸ¤” ì•„ì‰¬ìš´ ë§¤ì¹˜';
            descElement.textContent = `ì˜¤ëŠ˜ì˜ í–‰ìš´ ì•„ì´í…œê³¼ëŠ” ê±°ë¦¬ê°€ ìˆë„¤ìš”. '${luckyItemsData.main || 'ì¶”ì²œ ì•„ì´í…œ'}'ì´ë‚˜ '${luckyItemsData.zodiac || 'ë‹¤ë¥¸ ì•„ì´í…œ'}'ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`;
        } else {
            titleElement.textContent = 'ğŸ’« ë‹¤ë¥¸ ì•„ì´í…œì„ ì¶”ì²œë“œë ¤ìš”';
            descElement.textContent = `ì´ ì•„ì´í…œë³´ë‹¤ëŠ” ì˜¤ëŠ˜ì˜ í–‰ìš´ ì•„ì´í…œ '${luckyItemsData.main || 'ì¶”ì²œ ì•„ì´í…œ'}'ì„ ì‚¬ìš©í•´ë³´ì‹œëŠ” ê±´ ì–´ë–¨ê¹Œìš”?`;
        }
    }

    // ì—…ë¡œë“œ ì´ˆê¸°í™”
    function resetUpload() {
        uploadArea.style.display = 'block';
        resultCard.style.display = 'none';
        fileInput.value = '';
        document.getElementById('detected-item').textContent = 'ë¶„ì„ì¤‘...';
        document.getElementById('detected-colors').innerHTML = '';
        document.getElementById('luck-score').textContent = '0';
        document.getElementById('luck-progress').style.strokeDashoffset = '565';
    }

    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
