{% extends 'base.html' %}

{% block title %}운세 계산 - Fortune Life{% endblock %}

{% block extra_css %}
<style>
    .form-control, .form-select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        backdrop-filter: blur(5px);
    }
    
    .form-control:focus, .form-select:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: var(--primary);
        color: white;
        box-shadow: 0 0 0 0.25rem rgba(124, 58, 237, 0.25);
    }
    
    .form-control::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }
    
    .form-label {
        color: rgba(255, 255, 255, 0.95);
        font-weight: 500;
    }
    
    .form-text {
        color: rgba(255, 255, 255, 0.7) !important;
    }
    
    option {
        background: #1e1b4b;
        color: white;
    }
    
    /* 날짜 입력 아이콘 색상 변경 (브라우저별 상이) */
    ::-webkit-calendar-picker-indicator {
        filter: invert(1);
        opacity: 0.8;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="content-wrapper narrow">
        {# 페이지 헤더 #}
        {% include 'includes/page_header.html' with title="운세 계산" icon="fas fa-calculator" %}

        <div class="card-base card-lg">
                {% if not user.is_authenticated %}
                <div class="text-center mb-4">
                    <button type="button" class="btn btn-outline-light btn-sm rounded-pill px-3" id="resetFortuneBtn">
                        <i class="fas fa-redo me-1"></i> 다시 계산하기
                    </button>
                </div>
                {% endif %}

                <form method="POST" action="{% url 'fortune:loading' %}" id="fortuneForm" class="fortune-loading-form">
                    {% csrf_token %}

                    {% if not user.is_authenticated %}
                    <h5 class="mb-3 text-white border-bottom border-light border-opacity-25 pb-2">필수 정보</h5>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">생년월일 구분 <span class="text-danger">*</span></label>
                            <select name="calendar_type" class="form-select" required>
                                <option value="solar">양력</option>
                                <option value="lunar">음력</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">생년월일 <span class="text-danger">*</span></label>
                            <input type="date" name="birth_date" id="birth_date_fortune" class="form-control"
                                   min="1900-01-01" required>
                            <script>
                                const fortuneDateInput = document.getElementById('birth_date_fortune');
                                // 최대 날짜를 오늘로 설정
                                fortuneDateInput.max = new Date().toISOString().split("T")[0];

                                // 추가 검증: 날짜 선택 시 유효성 체크
                                fortuneDateInput.addEventListener('blur', function() {
                                    const selectedDate = new Date(this.value);
                                    const today = new Date();
                                    const minDate = new Date('1900-01-01');

                                    if (selectedDate > today) {
                                        showToast('미래 날짜는 선택할 수 없습니다.', 'error');
                                        this.value = '';
                                    } else if (selectedDate < minDate) {
                                        showToast('1900년 이후 날짜를 선택해주세요.', 'error');
                                        this.value = '';
                                    }
                                });
                            </script>
                        </div>
                    </div>
                    <div class="mb-3">
                        <small class="form-text">음력 생일인 경우 음력을 선택하세요</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">성별 <span class="text-danger">*</span></label>
                        <select name="gender" class="form-select" required>
                            <option value="">선택하세요</option>
                            <option value="M">남성</option>
                            <option value="F">여성</option>
                        </select>
                    </div>
                    
                    <div class="my-4 border-top border-light border-opacity-25"></div>
                    
                    <h5 class="mb-3 text-white">선택 정보</h5>
                    <p class="text-white opacity-visible small mb-3">더 정확한 운세를 위한 추가 정보입니다</p>
                    
                    {% comment %} <div class="mb-3">
                        <label class="form-label">태어난 시각</label>
                        <input type="time" name="birth_time" class="form-control">
                        <small class="form-text">시주를 포함한 정확한 사주 계산에 사용됩니다</small>
                    </div> {% endcomment %}
                    <div class="mb-3">
                        <label class="form-label">태어난 시각</label>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="time_ampm" style="flex: 1;">
                                <option value="AM">오전</option>
                                <option value="PM">오후</option>
                            </select>
                            <select class="form-select" id="time_hour" style="flex: 1;">
                                <option value="">시</option>
                                {% for i in "123456789012"|make_list %}
                                    {% if forloop.counter <= 12 %}
                                    <option value="{{ forloop.counter|stringformat:'02d' }}">{{ forloop.counter|stringformat:"02d" }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <select class="form-select" id="time_minute" style="flex: 1;">
                                <option value="">분</option>
                                {% for i in "012345"|make_list %}
                                    {% for j in "0123456789"|make_list %}
                                        <option value="{{ i }}{{ j }}">{{ i }}{{ j }}</option>
                                    {% endfor %}
                                {% endfor %}
                            </select>
                        </div>
                        <input type="hidden" name="birth_time" id="birth_time">
                        <small class="form-text">시주를 포함한 정확한 사주 계산에 사용됩니다</small>
                        
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                const ampmSelect = document.getElementById('time_ampm');
                                const hourSelect = document.getElementById('time_hour');
                                const minuteSelect = document.getElementById('time_minute');
                                const hiddenInput = document.getElementById('birth_time');

                                function updateTime() {
                                    const ampm = ampmSelect.value;
                                    let hour = parseInt(hourSelect.value);
                                    const minute = minuteSelect.value;

                                    if (!hour || !minute) {
                                        hiddenInput.value = '';
                                        return;
                                    }

                                    if (ampm === 'PM' && hour < 12) hour += 12;
                                    if (ampm === 'AM' && hour === 12) hour = 0;

                                    const formattedHour = hour.toString().padStart(2, '0');
                                    hiddenInput.value = `${formattedHour}:${minute}`;
                                }

                                ampmSelect.addEventListener('change', updateTime);
                                hourSelect.addEventListener('change', updateTime);
                                minuteSelect.addEventListener('change', updateTime);
                            });
                        </script>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">한자 이름</label>
                        <input type="text" name="chinese_name" class="form-control" placeholder="예: 金哲秀">
                        <small class="form-text">이름의 한자 획수를 통한 운세 보정</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">MBTI</label>
                        <select name="mbti" class="form-select">
                            <option value="">선택하세요</option>
                            <option value="ISTJ">ISTJ</option>
                            <option value="ISTP">ISTP</option>
                            <option value="ISFJ">ISFJ</option>
                            <option value="ISFP">ISFP</option>
                            <option value="INTJ">INTJ</option>
                            <option value="INTP">INTP</option>
                            <option value="INFJ">INFJ</option>
                            <option value="INFP">INFP</option>
                            <option value="ESTP">ESTP</option>
                            <option value="ESTJ">ESTJ</option>
                            <option value="ESFP">ESFP</option>
                            <option value="ESFJ">ESFJ</option>
                            <option value="ENTP">ENTP</option>
                            <option value="ENTJ">ENTJ</option>
                            <option value="ENFP">ENFP</option>
                            <option value="ENFJ">ENFJ</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">퍼스널컬러</label>
                        <select name="personal_color" class="form-select">
                            <option value="">선택하세요</option>
                            <option value="spring_warm">봄 웜톤</option>
                            <option value="summer_cool">여름 쿨톤</option>
                            <option value="autumn_warm">가을 웜톤</option>
                            <option value="winter_cool">겨울 쿨톤</option>
                        </select>
                        <small class="form-text">색상 추천에 반영됩니다</small>
                    </div>
                    
                    <div class="d-grid gap-2 mt-5">
                        <button type="submit" class="btn btn-gradient btn-lg rounded-pill fw-bold">
                            <i class="fas fa-star me-2"></i> 운세 확인하기
                        </button>
                    </div>
                    {% endif %}
                </form>
                
                {% if not user.is_authenticated %}
                <div class="text-center mt-4">
                    <p class="text-white opacity-visible mb-3">
                        회원가입하면 매일 자동으로 운세를 확인할 수 있습니다
                    </p>
                    <a href="{% url 'users:register' %}" class="btn btn-outline-light rounded-pill px-4">
                        회원가입하기
                    </a>
                </div>
                {% endif %}
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
    // 비로그인 사용자 - 운세 리셋 버튼
    document.addEventListener('DOMContentLoaded', function() {
        const resetBtn = document.getElementById('resetFortuneBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                // 폼 초기화
                document.getElementById('fortuneForm').reset();
                // AJAX로 세션 클리어
                fetch('{% url "fortune:reset" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                }).then(() => {
                    // 성공 메시지
                    showToast('운세가 초기화되었습니다. 새로운 정보를 입력해주세요.', 'success');
                });
            });
        }
    });
</script>
{% endblock %}
